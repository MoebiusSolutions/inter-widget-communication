try{window||(window=self)}catch(e){window=self}!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){var a,b=Array.prototype,c=Object.prototype,d=Function.prototype,e=String.prototype,f=Number.prototype,g=b.slice,h=b.splice,i=b.push,j=b.unshift,k=b.concat,l=d.call,m=c.toString,n=Array.isArray||function(a){return"[object Array]"===m.call(a)},o="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,p=Function.prototype.toString,q=function(a){try{return p.call(a),!0}catch(b){return!1}},r="[object Function]",s="[object GeneratorFunction]";a=function(a){if("function"!=typeof a)return!1;if(o)return q(a);var b=m.call(a);return b===r||b===s};var t,u=RegExp.prototype.exec,v=function(a){try{return u.call(a),!0}catch(b){return!1}},w="[object RegExp]";t=function(a){return"object"!=typeof a?!1:o?v(a):m.call(a)===w};var x,y=String.prototype.valueOf,z=function(a){try{return y.call(a),!0}catch(b){return!1}},A="[object String]";x=function(a){return"string"==typeof a?!0:"object"!=typeof a?!1:o?z(a):m.call(a)===A};var B=function(b){var c=m.call(b),d="[object Arguments]"===c;return d||(d=!n(b)&&null!==b&&"object"==typeof b&&"number"==typeof b.length&&b.length>=0&&a(b.callee)),d},C=function(a){var b,c=Object.defineProperty&&function(){try{var a={};Object.defineProperty(a,"x",{enumerable:!1,value:a});for(var b in a)return!1;return a.x===a}catch(c){return!1}}();return b=c?function(a,b,c,d){!d&&b in a||Object.defineProperty(a,b,{configurable:!0,enumerable:!1,writable:!0,value:c})}:function(a,b,c,d){!d&&b in a||(a[b]=c)},function(c,d,e){for(var f in d)a.call(d,f)&&b(c,f,d[f],e)}}(c.hasOwnProperty),D=function(a){var b=typeof a;return null===a||"object"!==b&&"function"!==b},E={ToInteger:function(a){var b=+a;return b!==b?b=0:0!==b&&b!==1/0&&b!==-(1/0)&&(b=(b>0||-1)*Math.floor(Math.abs(b))),b},ToPrimitive:function(b){var c,d,e;if(D(b))return b;if(d=b.valueOf,a(d)&&(c=d.call(b),D(c)))return c;if(e=b.toString,a(e)&&(c=e.call(b),D(c)))return c;throw new TypeError},ToObject:function(a){if(null==a)throw new TypeError("can't convert "+a+" to object");return Object(a)},ToUint32:function(a){return a>>>0}},F=function(){};C(d,{bind:function(b){var c=this;if(!a(c))throw new TypeError("Function.prototype.bind called on incompatible "+c);for(var d,e=g.call(arguments,1),f=function(){if(this instanceof d){var a=c.apply(this,k.call(e,g.call(arguments)));return Object(a)===a?a:this}return c.apply(b,k.call(e,g.call(arguments)))},h=Math.max(0,c.length-e.length),i=[],j=0;h>j;j++)i.push("$"+j);return d=Function("binder","return function ("+i.join(",")+"){ return binder.apply(this, arguments); }")(f),c.prototype&&(F.prototype=c.prototype,d.prototype=new F,F.prototype=null),d}});var G=l.bind(c.hasOwnProperty),H=function(){var a=[1,2],b=a.splice();return 2===a.length&&n(b)&&0===b.length}();C(b,{splice:function(a,b){return 0===arguments.length?[]:h.apply(this,arguments)}},!H);var I=function(){var a={};return b.splice.call(a,0,0,1),1===a.length}();C(b,{splice:function(a,b){if(0===arguments.length)return[];var c=arguments;return this.length=Math.max(E.ToInteger(this.length),0),arguments.length>0&&"number"!=typeof b&&(c=g.call(arguments),c.length<2?c.push(this.length-a):c[1]=E.ToInteger(b)),h.apply(this,c)}},!I);var J=1!==[].unshift(0);C(b,{unshift:function(){return j.apply(this,arguments),this.length}},J),C(Array,{isArray:n});var K=Object("a"),L="a"!==K[0]||!(0 in K),M=function(a){var b=!0,c=!0;return a&&(a.call("foo",function(a,c,d){"object"!=typeof d&&(b=!1)}),a.call([1],function(){"use strict";c="string"==typeof this},"x")),!!a&&b&&c};C(b,{forEach:function(b){var c,d=E.ToObject(this),e=L&&x(this)?this.split(""):d,f=-1,g=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.forEach callback must be a function");for(;++f<g;)f in e&&("undefined"!=typeof c?b.call(c,e[f],f,d):b(e[f],f,d))}},!M(b.forEach)),C(b,{map:function(b){var c,d=E.ToObject(this),e=L&&x(this)?this.split(""):d,f=e.length>>>0,g=Array(f);if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.map callback must be a function");for(var h=0;f>h;h++)h in e&&("undefined"!=typeof c?g[h]=b.call(c,e[h],h,d):g[h]=b(e[h],h,d));return g}},!M(b.map)),C(b,{filter:function(b){var c,d,e=E.ToObject(this),f=L&&x(this)?this.split(""):e,g=f.length>>>0,h=[];if(arguments.length>1&&(d=arguments[1]),!a(b))throw new TypeError("Array.prototype.filter callback must be a function");for(var i=0;g>i;i++)i in f&&(c=f[i],("undefined"==typeof d?b(c,i,e):b.call(d,c,i,e))&&h.push(c));return h}},!M(b.filter)),C(b,{every:function(b){var c,d=E.ToObject(this),e=L&&x(this)?this.split(""):d,f=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.every callback must be a function");for(var g=0;f>g;g++)if(g in e&&!("undefined"==typeof c?b(e[g],g,d):b.call(c,e[g],g,d)))return!1;return!0}},!M(b.every)),C(b,{some:function(b){var c,d=E.ToObject(this),e=L&&x(this)?this.split(""):d,f=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.some callback must be a function");for(var g=0;f>g;g++)if(g in e&&("undefined"==typeof c?b(e[g],g,d):b.call(c,e[g],g,d)))return!0;return!1}},!M(b.some));var N=!1;b.reduce&&(N="object"==typeof b.reduce.call("es5",function(a,b,c,d){return d})),C(b,{reduce:function(b){var c=E.ToObject(this),d=L&&x(this)?this.split(""):c,e=d.length>>>0;if(!a(b))throw new TypeError("Array.prototype.reduce callback must be a function");if(0===e&&1===arguments.length)throw new TypeError("reduce of empty array with no initial value");var f,g=0;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g++];break}if(++g>=e)throw new TypeError("reduce of empty array with no initial value")}for(;e>g;g++)g in d&&(f=b(f,d[g],g,c));return f}},!N);var O=!1;b.reduceRight&&(O="object"==typeof b.reduceRight.call("es5",function(a,b,c,d){return d})),C(b,{reduceRight:function(b){var c=E.ToObject(this),d=L&&x(this)?this.split(""):c,e=d.length>>>0;if(!a(b))throw new TypeError("Array.prototype.reduceRight callback must be a function");if(0===e&&1===arguments.length)throw new TypeError("reduceRight of empty array with no initial value");var f,g=e-1;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g--];break}if(--g<0)throw new TypeError("reduceRight of empty array with no initial value")}if(0>g)return f;do g in d&&(f=b(f,d[g],g,c));while(g--);return f}},!O);var P=Array.prototype.indexOf&&-1!==[0,1].indexOf(1,2);C(b,{indexOf:function(a){var b=L&&x(this)?this.split(""):E.ToObject(this),c=b.length>>>0;if(0===c)return-1;var d=0;for(arguments.length>1&&(d=E.ToInteger(arguments[1])),d=d>=0?d:Math.max(0,c+d);c>d;d++)if(d in b&&b[d]===a)return d;return-1}},P);var Q=Array.prototype.lastIndexOf&&-1!==[0,1].lastIndexOf(0,-3);C(b,{lastIndexOf:function(a){var b=L&&x(this)?this.split(""):E.ToObject(this),c=b.length>>>0;if(0===c)return-1;var d=c-1;for(arguments.length>1&&(d=Math.min(d,E.ToInteger(arguments[1]))),d=d>=0?d:c-Math.abs(d);d>=0;d--)if(d in b&&a===b[d])return d;return-1}},Q);var R=!{toString:null}.propertyIsEnumerable("toString"),S=function(){}.propertyIsEnumerable("prototype"),T=!G("x","0"),U=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],V=U.length;C(Object,{keys:function(b){var c=a(b),d=B(b),e=null!==b&&"object"==typeof b,f=e&&x(b);if(!e&&!c&&!d)throw new TypeError("Object.keys called on a non-object");var g=[],h=S&&c;if(f&&T||d)for(var i=0;i<b.length;++i)g.push(String(i));if(!d)for(var j in b)h&&"prototype"===j||!G(b,j)||g.push(String(j));if(R)for(var k=b.constructor,l=k&&k.prototype===b,m=0;V>m;m++){var n=U[m];l&&"constructor"===n||!G(b,n)||g.push(n)}return g}});var W=Object.keys&&function(){return 2===Object.keys(arguments).length}(1,2),X=Object.keys;C(Object,{keys:function(a){return X(B(a)?b.slice.call(a):a)}},!W);var Y=-621987552e5,Z="-000001",$=Date.prototype.toISOString&&-1===new Date(Y).toISOString().indexOf(Z);C(Date.prototype,{toISOString:function(){var a,b,c,d,e;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");for(d=this.getUTCFullYear(),e=this.getUTCMonth(),d+=Math.floor(e/12),e=(e%12+12)%12,a=[e+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],d=(0>d?"-":d>9999?"+":"")+("00000"+Math.abs(d)).slice(d>=0&&9999>=d?-4:-6),b=a.length;b--;)c=a[b],10>c&&(a[b]="0"+c);return d+"-"+a.slice(0,2).join("-")+"T"+a.slice(2).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"}},$);var _=function(){try{return Date.prototype.toJSON&&null===new Date(NaN).toJSON()&&-1!==new Date(Y).toJSON().indexOf(Z)&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(a){return!1}}();_||(Date.prototype.toJSON=function(b){var c=Object(this),d=E.ToPrimitive(c);if("number"==typeof d&&!isFinite(d))return null;var e=c.toISOString;if(!a(e))throw new TypeError("toISOString property is not callable");return e.call(c)});var aa=1e15===Date.parse("+033658-09-27T01:46:40.000Z"),ba=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z")),ca=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));Date.parse&&!ca&&!ba&&aa||(Date=function(a){var b=function(c,d,e,f,g,h,i){var j,k=arguments.length;return j=this instanceof a?1===k&&String(c)===c?new a(b.parse(c)):k>=7?new a(c,d,e,f,g,h,i):k>=6?new a(c,d,e,f,g,h):k>=5?new a(c,d,e,f,g):k>=4?new a(c,d,e,f):k>=3?new a(c,d,e):k>=2?new a(c,d):k>=1?new a(c):new a:a.apply(this,arguments),C(j,{constructor:b},!0),j},c=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:(\\.\\d{1,}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),d=[0,31,59,90,120,151,181,212,243,273,304,334,365],e=function(a,b){var c=b>1?1:0;return d[b]+Math.floor((a-1969+c)/4)-Math.floor((a-1901+c)/100)+Math.floor((a-1601+c)/400)+365*(a-1970)},f=function(b){return Number(new a(1970,0,1,0,0,0,b))};for(var g in a)G(a,g)&&(b[g]=a[g]);C(b,{now:a.now,UTC:a.UTC},!0),b.prototype=a.prototype,C(b.prototype,{constructor:b},!0);var h=function(b){var d=c.exec(b);if(d){var g,h=Number(d[1]),i=Number(d[2]||1)-1,j=Number(d[3]||1)-1,k=Number(d[4]||0),l=Number(d[5]||0),m=Number(d[6]||0),n=Math.floor(1e3*Number(d[7]||0)),o=Boolean(d[4]&&!d[8]),p="-"===d[9]?1:-1,q=Number(d[10]||0),r=Number(d[11]||0);return(l>0||m>0||n>0?24:25)>k&&60>l&&60>m&&1e3>n&&i>-1&&12>i&&24>q&&60>r&&j>-1&&j<e(h,i+1)-e(h,i)&&(g=60*(24*(e(h,i)+j)+k+q*p),g=1e3*(60*(g+l+r*p)+m)+n,o&&(g=f(g)),g>=-864e13&&864e13>=g)?g:NaN}return a.parse.apply(this,arguments)};return C(b,{parse:h}),b}(Date)),Date.now||(Date.now=function(){return(new Date).getTime()});var da=f.toFixed&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==0xde0b6b3a7640080.toFixed(0)),ea={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function(a,b){for(var c=-1,d=b;++c<ea.size;)d+=a*ea.data[c],ea.data[c]=d%ea.base,d=Math.floor(d/ea.base)},divide:function(a){for(var b=ea.size,c=0;--b>=0;)c+=ea.data[b],ea.data[b]=Math.floor(c/a),c=c%a*ea.base},numToString:function(){for(var a=ea.size,b="";--a>=0;)if(""!==b||0===a||0!==ea.data[a]){var c=String(ea.data[a]);""===b?b=c:b+="0000000".slice(0,7-c.length)+c}return b},pow:function qa(a,b,c){return 0===b?c:b%2===1?qa(a,b-1,c*a):qa(a*a,b/2,c)},log:function(a){for(var b=0,c=a;c>=4096;)b+=12,c/=4096;for(;c>=2;)b+=1,c/=2;return b}};C(f,{toFixed:function(a){var b,c,d,e,f,g,h,i;if(b=Number(a),b=b!==b?0:Math.floor(b),0>b||b>20)throw new RangeError("Number.toFixed called with invalid number of decimals");if(c=Number(this),c!==c)return"NaN";if(-1e21>=c||c>=1e21)return String(c);if(d="",0>c&&(d="-",c=-c),e="0",c>1e-21)if(f=ea.log(c*ea.pow(2,69,1))-69,g=0>f?c*ea.pow(2,-f,1):c/ea.pow(2,f,1),g*=4503599627370496,f=52-f,f>0){for(ea.multiply(0,g),h=b;h>=7;)ea.multiply(1e7,0),h-=7;for(ea.multiply(ea.pow(10,h,1),0),h=f-1;h>=23;)ea.divide(1<<23),h-=23;ea.divide(1<<h),ea.multiply(1,1),ea.divide(2),e=ea.numToString()}else ea.multiply(0,g),ea.multiply(1<<-f,0),e=ea.numToString()+"0.00000000000000000000".slice(2,2+b);return b>0?(i=e.length,e=b>=i?d+"0.0000000000000000000".slice(0,b-i+2)+e:d+e.slice(0,i-b)+"."+e.slice(i-b)):e=d+e,e}},da);var fa=e.split;2!=="ab".split(/(?:ab)*/).length||4!==".".split(/(.?)(.?)/).length||"t"==="tesst".split(/(s)*/)[1]||4!=="test".split(/(?:)/,-1).length||"".split(/.?/).length||".".split(/()()/).length>1?!function(){var a="undefined"==typeof/()??/.exec("")[1];e.split=function(b,c){var d=this;if("undefined"==typeof b&&0===c)return[];if(!t(b))return fa.call(this,b,c);var e,f,g,h,j=[],k=(b.ignoreCase?"i":"")+(b.multiline?"m":"")+(b.extended?"x":"")+(b.sticky?"y":""),l=0,m=new RegExp(b.source,k+"g");d+="",a||(e=new RegExp("^"+m.source+"$(?!\\s)",k));var n="undefined"==typeof c?-1>>>0:E.ToUint32(c);for(f=m.exec(d);f&&(g=f.index+f[0].length,!(g>l&&(j.push(d.slice(l,f.index)),!a&&f.length>1&&f[0].replace(e,function(){for(var a=1;a<arguments.length-2;a++)"undefined"==typeof arguments[a]&&(f[a]=void 0)}),f.length>1&&f.index<d.length&&i.apply(j,f.slice(1)),h=f[0].length,l=g,j.length>=n)));)m.lastIndex===f.index&&m.lastIndex++,f=m.exec(d);return l===d.length?!h&&m.test("")||j.push(""):j.push(d.slice(l)),j.length>n?j.slice(0,n):j}}():"0".split(void 0,0).length&&(e.split=function(a,b){return"undefined"==typeof a&&0===b?[]:fa.call(this,a,b)});var ga=e.replace,ha=function(){var a=[];return"x".replace(/x(.)?/g,function(b,c){a.push(c)}),1===a.length&&"undefined"==typeof a[0]}();ha||(e.replace=function(b,c){var d=a(c),e=t(b)&&/\)[*?]/.test(b.source);if(d&&e){var f=function(a){var d=arguments.length,e=b.lastIndex;b.lastIndex=0;var f=b.exec(a)||[];return b.lastIndex=e,f.push(arguments[d-2],arguments[d-1]),c.apply(this,f)};return ga.call(this,b,f)}return ga.call(this,b,c)});var ia=e.substr,ja="".substr&&"b"!=="0b".substr(-1);C(e,{substr:function(a,b){var c=a;return 0>a&&(c=Math.max(this.length+a,0)),ia.call(this,c,b)}},ja);var ka="	\n\x0B\f\r   ᠎             　\u2028\u2029\ufeff",la="​",ma="["+ka+"]",na=new RegExp("^"+ma+ma+"*"),oa=new RegExp(ma+ma+"*$"),pa=e.trim&&(ka.trim()||!la.trim());C(e,{trim:function(){if("undefined"==typeof this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(na,"").replace(oa,"")}},pa),8===parseInt(ka+"08")&&22===parseInt(ka+"0x16")||(parseInt=function(a){var b=/^0[xX]/;return function(c,d){var e=String(c).trim(),f=Number(d)||(b.test(e)?16:10);return a(e,f)}}(parseInt))}),function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){var a,b,c,d,e=Function.prototype.call,f=Object.prototype,g=e.bind(f.hasOwnProperty),h=g(f,"__defineGetter__");h&&(a=e.bind(f.__defineGetter__),b=e.bind(f.__defineSetter__),c=e.bind(f.__lookupGetter__),d=e.bind(f.__lookupSetter__)),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){var b=a.__proto__;return b||null===b?b:a.constructor?a.constructor.prototype:f});var i=function(a){try{return a.sentinel=0,0===Object.getOwnPropertyDescriptor(a,"sentinel").value}catch(b){return!1}};if(Object.defineProperty){var j=i({}),k="undefined"==typeof document||i(document.createElement("div"));if(!k||!j)var l=Object.getOwnPropertyDescriptor}if(!Object.getOwnPropertyDescriptor||l){var m="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(a,b){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(m+a);if(l)try{return l.call(Object,a,b)}catch(e){}var i;if(!g(a,b))return i;if(i={enumerable:!0,configurable:!0},h){var j=a.__proto__,k=a!==f;k&&(a.__proto__=f);var n=c(a,b),o=d(a,b);if(k&&(a.__proto__=j),n||o)return n&&(i.get=n),o&&(i.set=o),i}return i.value=a[b],i.writable=!0,i}}if(Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(a){return Object.keys(a)}),!Object.create){var n,o=!({__proto__:null}instanceof Object),p=function(){if(!document.domain)return!1;try{return!!new ActiveXObject("htmlfile")}catch(a){return!1}},q=function(){var a,b;return b=new ActiveXObject("htmlfile"),b.write("<script></script>"),b.close(),a=b.parentWindow.Object.prototype,b=null,a},r=function(){var a,b=document.createElement("iframe"),c=document.body||document.documentElement;return b.style.display="none",c.appendChild(b),b.src="javascript:",a=b.contentWindow.Object.prototype,c.removeChild(b),b=null,a};n=o||"undefined"==typeof document?function(){return{__proto__:null}}:function(){var a=p()?q():r();delete a.constructor,delete a.hasOwnProperty,delete a.propertyIsEnumerable,delete a.isPrototypeOf,delete a.toLocaleString,delete a.toString,delete a.valueOf,a.__proto__=null;var b=function(){};return b.prototype=a,n=function(){return new b},new b},Object.create=function(a,b){var c,d=function(){};if(null===a)c=n();else{if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object or null");d.prototype=a,c=new d,c.__proto__=a}return void 0!==b&&Object.defineProperties(c,b),c}}var s=function(a){try{return Object.defineProperty(a,"sentinel",{}),"sentinel"in a}catch(b){return!1}};if(Object.defineProperty){var t=s({}),u="undefined"==typeof document||s(document.createElement("div"));if(!t||!u)var v=Object.defineProperty,w=Object.defineProperties}if(!Object.defineProperty||v){var x="Property description must be an object: ",y="Object.defineProperty called on non-object: ",z="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(e,g,i){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError(y+e);if("object"!=typeof i&&"function"!=typeof i||null===i)throw new TypeError(x+i);if(v)try{return v.call(Object,e,g,i)}catch(j){}if("value"in i)if(h&&(c(e,g)||d(e,g))){var k=e.__proto__;e.__proto__=f,delete e[g],e[g]=i.value,e.__proto__=k}else e[g]=i.value;else{if(!h)throw new TypeError(z);"get"in i&&a(e,g,i.get),"set"in i&&b(e,g,i.set)}return e}}Object.defineProperties&&!w||(Object.defineProperties=function(a,b){if(w)try{return w.call(Object,a,b)}catch(c){}return Object.keys(b).forEach(function(c){"__proto__"!==c&&Object.defineProperty(a,c,b[c])}),a}),Object.seal||(Object.seal=function(a){if(Object(a)!==a)throw new TypeError("Object.seal can only be called on Objects.");return a}),Object.freeze||(Object.freeze=function(a){if(Object(a)!==a)throw new TypeError("Object.freeze can only be called on Objects.");return a});try{Object.freeze(function(){})}catch(A){Object.freeze=function(a){return function(b){return"function"==typeof b?b:a(b)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(a){if(Object(a)!==a)throw new TypeError("Object.preventExtensions can only be called on Objects.");return a}),Object.isSealed||(Object.isSealed=function(a){if(Object(a)!==a)throw new TypeError("Object.isSealed can only be called on Objects.");return!1}),Object.isFrozen||(Object.isFrozen=function(a){if(Object(a)!==a)throw new TypeError("Object.isFrozen can only be called on Objects.");return!1}),Object.isExtensible||(Object.isExtensible=function(a){if(Object(a)!==a)throw new TypeError("Object.isExtensible can only be called on Objects.");for(var b="";g(a,b);)b+="?";a[b]=!0;var c=g(a,b);return delete a[b],c})}),function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)"exports"===i[l]?k.push(g={}):k.push(b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){"use strict";function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:void 0===this?window:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/config",["exports"],function(a){"use strict";function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){"use strict";function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),f(b)}();b||(a.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){"use strict";function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){"use strict";function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){"use strict";function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}();var ozpIwc=ozpIwc||{};ozpIwc.util=function(a){return a.globalScope=function(){return this}(),a.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},a.now=function(){return(new Date).getTime()},a.resolveUriTemplate=function(a,b,c){var d={"+":function(a){return a},"":function(a){return encodeURIComponent(a)}},e=a.replace(/\{([\+\#\.\/\;\?\&]?)(.+?)\}/g,function(a,e,f){return d[e](b[f]||c[f])}),f=e.indexOf("://");return f>0&&(f+=3),e.replace(/\/\//g,function(a,b){return b>f?"/":a})},a.eventListeners={},a.addEventListener=function(b,c){var d=a.eventListeners[b];d||(d=a.eventListeners[b]=[]),d.push(c),a.globalScope.addEventListener(b,c)},a.removeEventListener=function(b,c){var d=a.eventListeners[b];d&&(a.eventListeners[b]=d.filter(function(a){return a!==c})),a.globalScope.removeEventListener(b,c)},a.purgeEventListeners=function(){ozpIwc.util.object.eachEntry(a.eventListeners,function(b,c){c.forEach(function(c){a.globalScope.removeEventListener(b,c)})}),a.eventListeners={}},a.extend=function(a,b){if(!a||!a.prototype)throw ozpIwc.log.error("Cannot create a new class for ",b," due to invalid baseclass:",a),new Error("Cannot create a new class due to invalid baseClass.  Dependency not loaded first?");return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b},a.safePostMessage=function(b,c,d){try{var e=c;a.structuredCloneSupport||"string"==typeof e||(e=JSON.stringify(c)),b.postMessage(e,d)}catch(f){try{b.postMessage(JSON.stringify(c),d)}catch(f){ozpIwc.log.debug("Invalid call to postMessage: "+f.message)}}},a.structuredCloneSupport=function(){var b="postMessage"in a.globalScope;try{a.globalScope.postMessage({toString:function(){b=!1}},"*")}catch(c){}return b}(),a.clone=function(a){if(!Array.isArray(a)&&"object"!=typeof a)return a;try{return JSON.parse(JSON.stringify(a))}catch(b){ozpIwc.log.error(b)}},a.parseQueryParams=function(b){b=b||a.globalScope.location.search;for(var c,d={},e=/\??([^&=]+)=?([^&]*)/g;null!==(c=e.exec(b));)d[c[1]]=decodeURIComponent(c[2]);return d},a.addQueryParams=function(b,c){if("string"!=typeof b)throw new Error("url should be a string.");var d={};switch(typeof c){case"object":if(Array.isArray(c)){if(0===c.length)return b;for(var e in c)if("string"==typeof c[e]){var f=a.parseQueryParams(c[e]);for(var g in f)d[g]=f[g]}}else{if(0===Object.keys(c).length)return b;d=c}break;case"undefined":return b;default:if(0===c.length)return b;d=a.parseQueryParams(c)}var h="",i=b.split("#");if(i.length>2)throw new Error("Invalid url.");b=i[0],h=i[1]||"",b+=-1===b.indexOf("?")?"?":"&";var j="";for(var k in d)b+=j+k+"="+d[k],j="&";return h.length>0&&(b+="#"+h),b},a.protocolPorts={"http:":"80","https:":"443","ws:":"80","wss:":"443"},a.determineOrigin=function(b){var c=document.createElement("a");if(c.href=b,c.origin)return c.origin;var d=c.protocol+"//"+c.hostname;return c.port&&a.protocolPorts[c.protocol]!==c.port&&(d+=":"+c.port),d},a.escapeRegex=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},a.parseOzpUrl=function(a){var b=/^(?:(?:web\+ozp|ozp):\/\/)?([0-9a-zA-Z](?:[-.\w])*)(\/[^?#]*)(\?[^#]*)?(#.*)?$/.exec(decodeURIComponent(a));if(b){var c={dst:b[1],resource:b[2],action:"get"};return c}return null},a.isIWCPacket=function(a){return"string"==typeof a.src&&"string"==typeof a.dst&&"number"==typeof a.ver&&"string"==typeof a.msgId},a.getInternetExplorerVersion=function(){var a,b,c=-1;return"Microsoft Internet Explorer"===navigator.appName?(a=navigator.userAgent,b=/MSIE ([0-9]{1,}[\.0-9]{0,})/,null!==b.exec(a)&&(c=parseFloat(RegExp.$1))):"Netscape"===navigator.appName&&(a=navigator.userAgent,b=/Trident\/.*rv:([0-9]{1,}[\.0-9]{0,})/,null!==b.exec(a)&&(c=parseFloat(RegExp.$1))),c},a.prerender=function(){return a.runningInWorker?Promise.resolve():new Promise(function(a,b){void 0===document||void 0===document.visibilityState||"prerender"!==document.visibilityState&&"unload"!==document.visibilityState?a():document.addEventListener("visibilitychange",function c(b){"prerender"!==document.visibilityState&&(document.removeEventListener(c),a())})})},a.runningInWorker="undefined"!=typeof WorkerGlobalScope&&this instanceof WorkerGlobalScope,a.openWindow=function(b,c,d){if("object"==typeof c){var e="";for(var f in c)e+=f+"="+encodeURIComponent(c[f])+"&";c=e}try{a.globalScope.open(b,c,d)}catch(g){a.globalScope.open(b+"?"+c,null,d)}},a.promiseDelay=function(a){return new Promise(function(b){setTimeout(function(){b()},a)})},a.ifUndef=function(a,b){return"undefined"==typeof a?b:a},a.getOrigin=function(){return location.origin?location.origin:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")},a}(ozpIwc.util||{});var ozpIwc=ozpIwc||{};ozpIwc.apiMap={"data.api":{address:"data.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","collect","addChild","removeChild"]},"intents.api":{address:"intents.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","collect","register","invoke","broadcast"]},"names.api":{address:"names.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","collect"]},"system.api":{address:"system.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","collect","launch"]},"locks.api":{address:"locks.api",actions:["get","watch","unwatch","list","lock","unlock","collect","bulkGet"]}};var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.ApiPromiseMixin=function(a,b,c){var d=function(a,b){b="undefined"==typeof b||b,a.address=a.address||"$nobody",a.connect=a.connect||function(){return a.connectPromise=Promise.resolve(),a.connectPromise},a.events||(a.events=new c.Event,a.events.mixinOnOff(a));var e=d.getCore();for(var f in e)a[f]=e[f];a.readLaunchParams(c.globalScope.name),a.readLaunchParams(c.globalScope.location.search),a.readLaunchParams(c.globalScope.location.hash),d.registerEvents(a),a.constructApiFunctions(),b&&a.connect()["catch"](function(a){})};d.registerEvents=function(a){a.on("disconnect",function(){a.promiseCallbacks={},a.registeredCallbacks={},c.globalScope.removeEventListener("message",a.postMessageHandler,!1),a.connectPromise=null})},d.getCore=function(){return{promiseCallbacks:{},msgIdSequence:0,receivedPackets:0,receivedBytes:0,sentPackets:0,sentBytes:0,startTime:c.now(),apiMap:a||{},wrapperMap:{},preconnectionQueue:[],launchParams:{},watchMsgMap:{},registeredCallbacks:{},launchedIntents:[],isConnected:function(){return"$nobody"!==this.address},readLaunchParams:function(a){for(var b,c=/ozpIwc.(\w+)=([^&#]+)/g;null!==(b=c.exec(a));){var d=decodeURIComponent(b[2]);try{d=JSON.parse(d)}catch(e){}this.launchParams[b[1]]=d}},receiveFromRouterImpl:function(a){var b=!1,c=a.packet||a;if(c.replyTo&&this.promiseCallbacks[c.replyTo]){var d=!1,e=function(){d=!0};this.promiseCallbacks[c.replyTo](c,e),d&&(this.cancelPromiseCallback(c.replyTo),b=!0)}if(!b&&c.replyTo&&this.registeredCallbacks[c.replyTo]){var f=!1,g=this,h=function(){f=!0,g.watchMsgMap[c.replyTo]&&"watch"===g.watchMsgMap[c.replyTo].action&&g.api(g.watchMsgMap[c.replyTo].dst).unwatch(g.watchMsgMap[c.replyTo].resource),g.cancelRegisteredCallback(c.replyTo)};b=this.registeredCallbacks[c.replyTo](c,h)}if(!b){if(c.src===this.address)return;"$bus.multicast"===c.dst?l(this,c)||this.events.trigger("busPacket",a):this.events.trigger("receive",a)}},constructApiFunctions:function(){for(var a in this.apiMap){var b=this.apiMap[a],c=b.address.replace(".api","");this.hasOwnProperty(c)&&this.apiMap[a].functionName!==c||!function(a,b){
a[c]=a.updateApi(b),a.apiMap[b]=a.apiMap[b]||{},a.apiMap[b].functionName=c}(this,b.address)}},gatherApiInformation:function(){var a=this;return this.send({dst:"names.api",action:"get",resource:"/api"}).then(function(a){if("ok"===a.response)return a.entity;throw a.response}).then(function(b){var c=[];return b.forEach(function(b){var d=a.send({dst:"names.api",action:"get",resource:b}).then(function(c){if("ok"!==c.response)throw c.response;var d=b.replace("/api/","");a.apiMap[d]=a.apiMap[d]||{},a.apiMap[d].address=d,a.apiMap[d].actions=c.entity.actions});c.push(d)}),Promise.all(c)})},cancelPromiseCallback:function(a){var b=!1;return a&&(delete this.promiseCallbacks[a],b=!0),b},cancelRegisteredCallback:function(a){var b=!1;return a&&(delete this.registeredCallbacks[a],delete this.watchMsgMap[a],b=!0),b},on:function(a,b){return"connected"===a&&this.isConnected()?void b(this):this.events.on.apply(this.events,arguments)},off:function(a,b){return this.events.off.apply(this.events,arguments)},intentInvocationHandling:function(a,b,c){var d,e,f=this;return c=c||function(){},b=b||{},e=b.entity?Promise.resolve(b):f.send({dst:"intents.api",action:"get",resource:b.resource}),e.then(function(b){return d=b,d.entity.invokePacket.msgId===a.msgId?(c(a),Promise.reject("ownInvoke")):f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{handler:{resource:a.resource,address:f.address},me:Date.now(),state:"running"}})}).then(function(){return c(d.entity,b)}).then(function(a){return a&&a.intentIncomplete?Promise.resolve():f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{reply:{entity:a||{},contentType:d.entity.intent.type},state:"complete"}})})["catch"](function(a){return"ownInvoke"!==a?(console.error("Error in handling intent: ",a," -- Reporting error on in-flight intent node:",d.resource),f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{reply:{entity:a.toString()||{},contentType:"text/plain"},state:"error"}})):void 0})},api:function(a){return this.wrapperMap[a]||this.updateApi(a)},updateApi:function(a){var b=function(){return b};if(this.wrapperMap[a]=b,this.apiMap.hasOwnProperty(a)){var c=this.apiMap[a],d=this;b.messageBuilder={},b.messageBuilder.bulkSend=function(a,b){var d={dst:c.address,action:"bulkSend",resource:"/",entity:a};return{packet:d,callback:b}},b.bulkSend=function(a,b){return function(c){var d=a(c);return b.send(d.packet,d.callback)}}(b.messageBuilder.bulkSend,this);for(var e=0;e<c.actions.length;++e){var f=c.actions[e];b.messageBuilder[f]=j(c.address,f,this),b[f]=i(b.messageBuilder[f],this)}b.Reference=function(a,b){this.resource=a,this.apiWrapper=d,this.defaultPacket={resource:this.resource},this.messageBuilder={};for(var e in b)this.defaultPacket[e]=b[e];for(var f=0;f<c.actions.length;++f){var g=c.actions[f];this.messageBuilder[g]=k(c.address,g,this.defaultPacket,this.apiWrapper),this[g]=i(this.messageBuilder[g],this)}},b.Reference.prototype.send=function(a,b){var c,d,e=this,f=new Promise(function(a,b){c=a,d=b}),g=function(a,c){var d=e.defaultPacket.fullCallback?a:a.entity;return"complete"===a.response||"update"===a.response||a.invokePacket||e.defaultPacket.collect?b(d,c,a):a.entity.newValue!==a.entity.oldValue?b(d,c,a):void 0};return this.apiWrapper.send(a,g,c,d),f.then(function(a){return e.defaultPacket.fullResponse?a:a.entity},function(a){throw e.defaultPacket.fullResponse?a:a.response})},b.Reference.prototype.updateDefaults=function(a){if("object"==typeof a)for(var b in a)this.defaultPacket[b]=a[b];return this}}return b.apiName=a,b},fixPacket:function(a){var b={ver:1,src:a.src||this.address,msgId:a.msgId||"p:"+this.msgIdSequence++,time:a.time||(new Date).getTime()};for(var d in a)b[d]=c.ifUndef(a[d],b[d]);return"$nobody"===b.src&&(b.src=this.address),b},registerResponses:function(a,b,c,d){var e=this;b&&(this.registeredCallbacks[a.msgId]=function(c,d){return/(ok).*/.test(c.response)||/(bad|no).*/.test(c.response)?!1:(c.entity&&c.entity.inFlightIntent?e.intentInvocationHandling(a,c.entity.inFlightIntent,b):b(c,d,c),!0)}),"none"!==a.respondOn&&(this.promiseCallbacks[a.msgId]=function(b,f){"intents.api"===b.src&&"invoke"===a.action&&/(ok).*/.test(b.response)||"broadcast"===a.action&&/(complete).*/.test(b.response)||("intents.api"===b.src&&"broadcast"===a.action&&/(pending).*/.test(b.response)?(e.registeredCallbacks[a.msgId]&&(e.registeredCallbacks[a.msgId].handlers=b.entity.handlers||[],e.registeredCallbacks[a.msgId].pRes=c,e.registeredCallbacks[a.msgId].reply=b),f()):"$transport"===b.src||/(ok).*/.test(b.response)||/(complete).*/.test(b.response)?(f(),c(b)):/(bad|no).*/.test(b.response)&&(f(),d(b)))}),"watch"===a.action?this.watchMsgMap[a.msgId]=a:"unwatch"===a.action&&a.replyTo&&this.cancelRegisteredCallback(a.replyTo),"bulkSend"===a.action&&a.entity.forEach(function(a){e.registerResponses(a.packet,a.callback,a.res,a.rej)})},send:function(a,b,c,d){if(this.sendingBlocked)return Promise.resolve({response:"dropped"});var e=c,f=d,g=new Promise(function(a,b){e||f||(e=a,f=b)});if(!this.isConnected()&&"$transport"!==a.dst)return this.preconnectionQueue.push({fields:a,callback:b,promiseRes:e,promiseRej:f}),g;var h=this.fixPacket(a);return this.registerResponses(h,b,e,f),m(h),this.sendImpl(h),this.sentBytes+=h.length,this.sentPackets++,g},afterConnected:function(){var a=this;return a.preconnectionQueue.forEach(function(b){a.send(b.fields,b.callback,b.promiseRes,b.promiseRej)}),a.preconnectionQueue=[],!a.launchParams.inFlightIntent||a.internal?(a.events.trigger("connected"),Promise.resolve()):a.intents().get(a.launchParams.inFlightIntent).then(function(b){if(b&&b.entity&&b.entity.intent){var c=b.entity.entity||{};if("ok"===b.response)for(var d in c)a.launchParams[d]=c[d];a.intents().set(a.launchParams.inFlightIntent,{entity:{state:"complete"}}),a.launchParams.launchData&&a.launchParams.launchData.inFlightIntent&&a.launchedIntents.push(a.launchParams.launchData.inFlightIntent)}a.events.trigger("connected")})["catch"](function(b){console.error(a.launchParams.inFlightIntent," not handled, reason: ",b),a.events.trigger("connected")})}}};var e=function(a,b){for(var c in a.launchedIntents){var d="/"+a.launchedIntents[c].entity.intent.type+"/"+a.launchedIntents[c].entity.intent.action;b.packet.resource===d&&(a.intentInvocationHandling(b.packet,a.launchedIntents[c],b.callback),delete a.launchedIntents[c])}},f=function(a){if(a.callback){var b=a.callback;a.callback=function(a,c){b(a,c),a=a||{},a.entity=a.entity||{},"error"!==a.entity.state&&"complete"!==a.entity.state||c()}}},g=function(a,b){var c=b.callback||function(){},d=a.registeredCallbacks;b.callback=function(b,e,f){if(d[f.replyTo]){var g=d[f.replyTo],h=g.handlers,i=function(a){var b=h.indexOf(a);b>-1&&h.splice(b,1),0===h.length&&(g.reply.entity=g.results,g.reply.response="complete",g.pRes(g.reply),e())};"complete"===f.response?(g.results=g.results||{},g.results[f.resource]=f.entity,i(f.resource)):f.entity&&"error"===f.entity.state&&a.registeredCallbacks[f.replyTo]?i(f.entity.handler.resource):c(f,e)}}},h=function(a,b){var c=a.apiWrapper||a;switch(b.packet.action){case"register":e(c,b);break;case"invoke":f(b);break;case"broadcast":g(c,b)}},i=function(a,b){return function(){var c=a.apply(this,arguments);return"intents.api"===c.packet.dst&&h(b,c),b.send(c.packet,c.callback)}},j=function(a,b,c){return function(d,e,f){var g=f,h=e;"function"==typeof e&&(g=e,h={});var i={dst:a,action:b,resource:d,entity:{}};for(var j in h)i[j]=h[j];var k,l,m=new Promise(function(a,b){k=a,l=b});return m.packet=c.fixPacket(i),m.callback=g,m.res=k,m.rej=l,m}},k=function(a,b,c,d){return function(e,f){var g=e,h=f;"function"==typeof e&&(h=e,g=void 0);var i=c;i.dst=a,i.action=b,i.entity=g;var j,k,l=new Promise(function(a,b){j=a,k=b});return l.packet=d.fixPacket(i),l.callback=h,l.res=j,l.rej=k,l}},l=function(a,b){switch(b.action){case"connect":return a.events.trigger("addressConnects",b.entity.address,b),!0;case"disconnect":return a.events.trigger("addressDisconnects",b.entity.address,b),!0}},m=function(a){return"bulkSend"===a.action&&(a.entity=a.entity.map(function(a){return{packet:a.packet}})),a};return d}(ozpIwc.apiMap,ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.CancelableEvent=function(){var a=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null};return a.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this},a}();var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.Event=function(a){var b=function(){this.events={}};return b.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},b.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},b.prototype.trigger=function(b){var c=Array.prototype.slice.call(arguments,1);c.length<1&&c.push(new a.CancelableEvent);var d=this.events[b]||[];return d.forEach(function(a){a.apply(this,c)}),c[0]},b.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},b}(ozpIwc.util),window.console&&console.log||(console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}});var ozpIwc=ozpIwc||{};ozpIwc.log=function(){return{NONE:{logLevel:!0,severity:0,name:"NONE"},DEFAULT:{logLevel:!0,severity:1,name:"DEFAULT"},ERROR:{logLevel:!0,severity:3,name:"ERROR"},INFO:{logLevel:!0,severity:6,name:"INFO"},DEBUG:{logLevel:!0,severity:7,name:"DEBUG"},ALL:{logLevel:!0,severity:10,name:"ALL"},threshold:3,setThreshold:function(a){if("number"==typeof a)ozpIwc.log.threshold=a;else{if("number"!=typeof a.severity)throw new TypeError("Threshold must be a number or one of the ozpIwc.log constants.  Instead got"+a);ozpIwc.log.threshold=a.severity}},log:function(a){a.logLevel===!0&&"number"==typeof a.severity?ozpIwc.log.logMsg(a,Array.prototype.slice.call(arguments,1)):ozpIwc.log.logMsg(ozpIwc.log.DEFAULT,Array.prototype.slice.call(arguments,0))},logMsg:function(a,b){if(!(a.severity>ozpIwc.log.threshold)&&console&&console.log){var c=b.reduce(function(a,b){return b instanceof Error?a+b.toString()+(b.stack?" -- "+b.stack:""):"object"==typeof b?a+JSON.stringify(b,null,2):a+b},"["+a.name+"] ");console.log(c)}},error:function(){ozpIwc.log.logMsg(ozpIwc.log.ERROR,Array.prototype.slice.call(arguments,0))},debug:function(){ozpIwc.log.logMsg(ozpIwc.log.DEBUG,Array.prototype.slice.call(arguments,0))},info:function(){ozpIwc.log.logMsg(ozpIwc.log.INFO,Array.prototype.slice.call(arguments,0))}}}();var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.object=function(){return{eachEntry:function(a,b,c){var d=[];for(var e in a)d.push(b.call(c,e,a[e],a.hasOwnProperty(e)));return d},values:function(a,b){b=b||function(a,b){return!0};var c=[];for(var d in a)b(d,a[d])&&c.push(a[d]);return c}}}();var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.PacketRouter=function(a,b){var c=function(){this.routes={},this.defaultRoute=function(){return!1},this.defaultSelf=this};return c.prototype.declareRoute=function(a,d,e){if(!a||!a.action||!a.resource)throw new Error("Bad route declaration: "+JSON.stringify(a,null,2));a.handler=d,a.filters=a.filters||[],a.handlerSelf=e,a.uriTemplate=c.uriTemplate(a.resource);var f=b.ensureArray(a.action);return f.forEach(function(b){this.routes.hasOwnProperty(b)||(this.routes[b]=[]),this.routes[b].push(a)},this),this},c.prototype.filterChain=function(b,c,d,e,f,g){if(!g.length)return e.handler.call(f,b,c,d);var h=g.shift(),i=this,j=!1,k=h.call(f,b,c,d,function(){return j=!0,i.filterChain(b,c,d,e,f,g)});return j?a.debug("Filter returned ",k):a.debug("Filter did not call next() and did not throw an exception",h),k},c.prototype.routePacket=function(a,b,c,d){d=d||{};var e=d.action||a.action,f=d.resource||a.resource;if(!e||!f)return b.defaultRouteCause="nonRoutablePacket",this.defaultRoute.call(c,a,b,{});if(b=b||{},c=c||this.defaultSelf,!this.routes.hasOwnProperty(e))return b.defaultRouteCause="noAction",this.defaultRoute.call(c,a,b,{});for(var g=this.routes[e],h=0;h<g.length;++h){var i=g[h];if(i){var j=i.uriTemplate(f);if(j){c=i.handlerSelf||c;var k=i.filters.slice();return this.filterChain(a,b,j,i,c,k)}}}return b.defaultRouteCause="noResource",this.defaultRoute.call(c,a,b,{})},c.prototype.declareDefaultRoute=function(a){this.defaultRoute=a},c.uriTemplate=function(a){var b=[],c="^"+a.replace(/\{.+?\}|[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,function(a){if(1===a.length)return"\\"+a;var c=a.indexOf(":");return c>0?(b.push(a.slice(1,c)),"("+a.slice(c+1,-1)+")"):(b.push(a.slice(1,-1)),"([^/]+)")})+"$",d=new RegExp(c);return function(a){var c=d.exec(a);if(!c)return null;for(var e={},f=1;f<c.length;++f)e[b[f-1]]=c[f];return e}},c.mixin=function(a){var b=new c,d=Object.getPrototypeOf(a.prototype);d&&d.routePacket?b.defaultRoute=function(a,b){return d.routePacket.apply(this,arguments)}:b.defaultRoute=function(a,b){return this.defaultRoute?this.defaultRoute.apply(this,arguments):!1},a.declareRoute=function(a,c){b.declareRoute(a,c)},a.prototype.routePacket=function(a,c){return b.routePacket(a,c,this)}},c}(ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.stats=ozpIwc.metric.stats||{},ozpIwc.metric.stats=function(a){return a.DEFAULT_POOL_SIZE=1028,a.Sample=function(){this.clear()},a.Sample.prototype.update=function(a){this.values.push(a)},a.Sample.prototype.clear=function(){this.values=[],this.count=0},a.Sample.prototype.size=function(){return this.values.length},a.Sample.prototype.getValues=function(){return this.values},a.UniformSample=ozpIwc.util.extend(a.Sample,function(b){a.Sample.apply(this),this.limit=b||a.DEFAULT_POOL_SIZE}),a.UniformSample.prototype.update=function(a){if(this.count++,this.size()<this.limit)this.values.push(a);else{var b=parseInt(Math.random()*this.count);b<this.limit&&(this.values[b]=a)}},a}(ozpIwc.metric.stats);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.stats=ozpIwc.metric.stats||{},ozpIwc.metric.stats.BinaryHeap=function(){var a=function(a){this.content=[],this.scoreFunction=a};return a.prototype={clone:function(){var b=new a(this.scoreFunction);return b.content=JSON.parse(JSON.stringify(this.content)),b},push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},peek:function(){return this.content[0]},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]===a){var d=this.content.pop();return c!==b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)),!0}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null,h=null;if(b>f){var i=this.content[f];h=this.scoreFunction(i),d>h&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null===g?d:h)>k&&(g=e)}if(null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}},a}();var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.stats=ozpIwc.metric.stats||{},ozpIwc.metric.stats=function(a){return a.DEFAULT_RESCALE_THRESHOLD=36e5,a.DEFAULT_DECAY_ALPHA=.015,a.ExponentiallyDecayingSample=ozpIwc.util.extend(a.Sample,function(b,c){a.Sample.apply(this),this.limit=b||a.DEFAULT_POOL_SIZE,this.alpha=c||a.DEFAULT_DECAY_ALPHA,this.rescaleThreshold=a.DEFAULT_RESCALE_THRESHOLD}),a.ExponentiallyDecayingSample.prototype.getValues=function(){for(var a,b=[],c=this.values.clone();void 0!==(a=c.pop());)b.push(a.val);return b},a.ExponentiallyDecayingSample.prototype.size=function(){return this.values.size()},a.ExponentiallyDecayingSample.prototype.newHeap=function(){return new a.BinaryHeap(function(a){return a.priority})},a.ExponentiallyDecayingSample.prototype.now=function(){return ozpIwc.util.now()},a.ExponentiallyDecayingSample.prototype.tick=function(){return this.now()/1e3},a.ExponentiallyDecayingSample.prototype.clear=function(){this.values=this.newHeap(),this.count=0,this.startTime=this.tick(),this.nextScaleTime=this.now()+this.rescaleThreshold},a.ExponentiallyDecayingSample.prototype.update=function(a,b){void 0===b?b=this.tick():b/=1e3;var c=this.weight(b-this.startTime)/Math.random(),d={val:a,priority:c};if(this.count<this.limit)this.count+=1,this.values.push(d);else{var e=this.values.peek();e.priority<c&&(this.values.push(d),this.values.pop())}this.now()>this.nextScaleTime&&this.rescale()},a.ExponentiallyDecayingSample.prototype.weight=function(a){return Math.exp(this.alpha*a)},a.ExponentiallyDecayingSample.prototype.rescale=function(){this.nextScaleTime=this.now()+this.rescaleThreshold;var a=this.values.content,b=[],c=this.startTime;this.startTime=this.tick();for(var d=0;d<a.length;d++)b.push({val:a[d].val,priority:a[d].priority*Math.exp(-this.alpha*(this.startTime-c))});this.values.content=b},a}(ozpIwc.metric.stats);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.stats=ozpIwc.metric.stats||{},ozpIwc.metric.stats=function(a){return a.M1_ALPHA=1-Math.exp(-5/60),a.M5_ALPHA=1-Math.exp(-5/60/5),a.M15_ALPHA=1-Math.exp(-5/60/15),a.ExponentiallyWeightedMovingAverage=function(a,b){this.alpha=a,this.interval=b||5e3,this.currentRate=null,this.uncounted=0,this.lastTick=ozpIwc.util.now()},a.ExponentiallyWeightedMovingAverage.prototype.update=function(a){this.uncounted+=a||1,this.tick()},a.ExponentiallyWeightedMovingAverage.prototype.tick=function(){var a=ozpIwc.util.now(),b=a-this.lastTick;if(b>this.interval){this.lastTick=a-b%this.interval;for(var c=Math.floor(b/this.interval),d=0;c>d;++d){var e=this.uncounted/this.interval;this.uncounted=0,null!==this.currentRate?this.currentRate+=this.alpha*(e-this.currentRate):this.currentRate=e}}},a.ExponentiallyWeightedMovingAverage.prototype.rate=function(){return 1e3*this.currentRate},a}(ozpIwc.metric.stats);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.BaseMetric=function(){var a=function(){this.value=0,this.name="",this.unitName=""};return a.prototype.get=function(){return this.value},a.prototype.unit=function(a){return a?(this.unitName=a,this):this.unitName},a}();var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.Counter=function(a,b){var c=b.extend(a.BaseMetric,function(){a.BaseMetric.apply(this,arguments),this.value=0});return c.prototype.inc=function(a){return this.value+=a?a:1},c.prototype.dec=function(a){return this.value-=a?a:1},c}(ozpIwc.metric.types,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.Gauge=function(a,b){var c=b.extend(a.BaseMetric,function(b){a.BaseMetric.apply(this,arguments),this.callback=b});return c.prototype.set=function(a){return this.callback=a,this},c.prototype.get=function(){return this.callback?this.callback():void 0},c}(ozpIwc.metric.types,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.Histogram=function(a,b,c){var d=c.extend(a.BaseMetric,function(){a.BaseMetric.apply(this,arguments),this.sample=new b.ExponentiallyDecayingSample,this.clear()});return d.prototype.clear=function(){this.sample.clear(),this.min=this.max=null,this.varianceMean=0,this.varianceM2=0,this.sum=0,this.count=0},d.prototype.mark=function(a,b){b=b||c.now(),this.sample.update(a,b),this.max=null===this.max?a:Math.max(this.max,a),this.min=null===this.min?a:Math.min(this.min,a),this.sum+=a,this.count++;var d=a-this.varianceMean;return this.varianceMean+=d/this.count,this.varianceM2+=d*(a-this.varianceMean),this.count},d.prototype.get=function(){var a=this.sample.getValues().map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),b=function(b){var c=b*a.length;if(c>=a.length)return a[a.length-1];c=Math.max(0,c),c=Math.min(c,a.length+1);var d=a[Math.floor(c)-1],e=a[Math.floor(c)];return d+(c-Math.floor(c))*(e-d)};return{percentile10:b(.1),percentile25:b(.25),median:b(.5),percentile75:b(.75),percentile90:b(.9),percentile95:b(.95),percentile99:b(.99),percentile999:b(.999),variance:this.count<1?null:this.varianceM2/(this.count-1),mean:0===this.count?null:this.varianceMean,stdDev:this.count<1?null:Math.sqrt(this.varianceM2/(this.count-1)),count:this.count,sum:this.sum,max:this.max,min:this.min}},d}(ozpIwc.metric.types,ozpIwc.metric.stats,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.Meter=function(a,b,c){var d=c.extend(a.BaseMetric,function(){a.BaseMetric.apply(this,arguments),this.m1Rate=new b.ExponentiallyWeightedMovingAverage(b.M1_ALPHA),this.m5Rate=new b.ExponentiallyWeightedMovingAverage(b.M5_ALPHA),this.m15Rate=new b.ExponentiallyWeightedMovingAverage(b.M15_ALPHA),this.startTime=c.now(),this.value=0});return d.prototype.mark=function(a){return a=a||1,this.value+=a,this.m1Rate.update(a),this.m5Rate.update(a),this.m15Rate.update(a),this.value},d.prototype.get=function(){return{rate1m:this.m1Rate.rate(),rate5m:this.m5Rate.rate(),rate15m:this.m15Rate.rate(),rateMean:this.value/(c.now()-this.startTime)*1e3,count:this.value}},d.prototype.tick=function(){this.m1Rate.tick(),this.m5Rate.tick(),this.m15Rate.tick()},d}(ozpIwc.metric.types,ozpIwc.metric.stats,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.types=ozpIwc.metric.types||{},ozpIwc.metric.types.Timer=function(a,b){var c=b.extend(a.BaseMetric,function(){a.BaseMetric.apply(this,arguments),this.meter=new a.Meter,this.histogram=new a.Histogram});return c.prototype.mark=function(a,b){this.meter.mark(),this.histogram.mark(a,b)},c.prototype.start=function(){var a=this,c=b.now();return function(){var d=b.now();a.mark(d-c,d)}},c.prototype.time=function(a){var c=b.now();try{a()}finally{var d=b.now();this.mark(d-c,d)}},c.prototype.get=function(){var a=this.histogram.get(),b=this.meter.get();for(var c in b)a[c]=b[c];return a},c}(ozpIwc.metric.types,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.metric=ozpIwc.metric||{},ozpIwc.metric.Registry=function(a){var b=function(){this.metrics={};var a=this;this.gauge("registry.metrics.types").set(function(){return Object.keys(a.metrics).length})},c=function(a,b,c){var d=a.metrics[b];return d?d instanceof c?d:null:(d=a.metrics[b]=new c,d.name=b,d)};return b.prototype.makeName=function(a){return Array.prototype.slice.call(a).join(".")},b.prototype.counter=function(b){return c(this,this.makeName(arguments),a.Counter)},b.prototype.meter=function(b){return c(this,this.makeName(arguments),a.Meter)},b.prototype.gauge=function(b){return c(this,this.makeName(arguments),a.Gauge)},b.prototype.histogram=function(b){return c(this,this.makeName(arguments),a.Histogram)},b.prototype.timer=function(b){return c(this,this.makeName(arguments),a.Timer)},b.prototype.register=function(a,b){return this.metrics[this.makeName(a)]=b,b},b.prototype.toJson=function(){var a={};for(var b in this.metrics){for(var c=b.split("."),d=a;c.length>1;){var e=c.shift();d=d[e]=d[e]||{}}d[c[0]]=this.metrics[b].get()}return a},b.prototype.allMetrics=function(){var a=[];for(var b in this.metrics)a.push(this.metrics[b]);return a},b}(ozpIwc.metric.types||{});var ozpIwc=ozpIwc||{};ozpIwc.util=function(a,b){return b.ajax=function(c){return new Promise(function(d,e){var f=["PUT","POST","PATCH"],g=new XMLHttpRequest;g.open(c.method,c.href,!0),g.withCredentials=!0;var h=!0;Array.isArray(c.headers)&&c.headers.forEach(function(a){"Content-Type"===a.name&&(h=!1),g.setRequestHeader(a.name,a.value)}),f.indexOf(c.method)>=0&&h&&g.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),g.onload=function(){if(2===Math.floor(this.status/100)){var f;try{f=JSON.parse(this.responseText)}catch(g){f=this.reponseText||this.responseXML}a.info("[AJAX] ["+c.method+"] ["+c.href+"] [RESOLVE]"),d({response:f,header:b.ajaxResponseHeaderToJSON(this.getAllResponseHeaders()),url:this.responseURL})}else a.info("[AJAX] ["+c.method+"] ["+c.href+"] [REJECT] ("+this.status+")"),e(this)},g.ontimeout=function(b){a.info("[AJAX] ["+c.method+"] ["+c.href+"] [REJECT] ("+b+")"),e(this)},g.onerror=function(b){a.info("[AJAX] ["+c.method+"] ["+c.href+"] [REJECT] ("+b+")"),e(this)},a.info("[AJAX] ["+c.method+"] ["+c.href+"]");try{"POST"===c.method||"PUT"===c.method?g.send(c.data):g.send()}catch(i){e(i)}})},b.ajaxResponseHeaderToJSON=function(a){var b={};return a.split("\n").forEach(function(a){var c=a.split(":");2===c.length&&(b[c[0].trim()]=c[1].trim())}),b},b}(ozpIwc.log,ozpIwc.util||{});var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.AjaxPersistenceQueue=function(a,b){var c=function(a){a=a||{},this.poolSize=a.poolSize||1,this.syncPool=[];for(var b=0;b<this.poolSize;++b)this.syncPool.push(Promise.resolve());this.nextSlot=0,this.queuedSyncs={}},d=function(a,b,c){return a.queuedSyncs[b]?a.queuedSyncs[b]:(a.nextSlot=(a.nextSlot+1)%a.poolSize,a.syncPool[a.nextSlot]=a.queuedSyncs[b]=a.syncPool[a.nextSlot].then(function(){return c()}).then(function(c){return delete a.queuedSyncs[b],c},function(c){throw delete a.queuedSyncs[b],c}),a.queuedSyncs[b])},e=function(c){var d=c.getSelfUri()||{},e=d.href,f=d.type;if(!e)return Promise.resolve();if(c.deleted)return b.ajax({href:e,method:"DELETE"});var g=c.serialize();return"string"!=typeof g&&(g=JSON.stringify(g)),a.debug("PUT "+e,g),b.ajax({href:e,method:"PUT",data:g,headers:[{name:"Content-Type",value:f}]}).then(function(b){return a.debug("  saving to "+e,b),b},function(b){a.error("  FAILED saving to "+e,b)})};return c.prototype.queueNode=function(b,c){var f=function(){return e(c)["catch"](function(){a.info("[AJAX] ["+b+"] Ignoring persist, as one is already queued.")})};return d(this,"Node:"+b,f)},c.prototype.queueAjax=function(a){if(a=a||{},!a.href)throw"Ajax queue requires href";if(!a.method)throw"Ajax queue requires method";var c,e,f=new Promise(function(a,b){c=a,e=b}),g=function(){return b.ajax(a).then(c,e)};return d(this,a.method+":"+a.href+":"+Date.now(),g),f},c}(ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.AsyncAction=function(){var a=function(){this.callbacks={}};return a.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},a.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},a.prototype.success=function(a,b){return this.when("success",a,b)},a.prototype.failure=function(a,b){return this.when("failure",a,b)},a.all=function(b){b=ozpIwc.util.ensureArray(b||[]);var c=new a,d=b.length,e=this,f=[];return 0===b.length?c.resolve("success",[]):(b.forEach(function(a,b){e.isAnAction(a)?a.success(function(a){f[b]=a,0===--d&&c.resolve("success",f)},e).failure(function(a){c.resolve("failure",a)},e):(f[b]=a,0===--d&&c.resolve("success",f))}),c)},a.isAnAction=function(b){return a.prototype.isPrototypeOf(b)},a}();var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.util=ozpIwc.util||{},ozpIwc.util.halLoader=function(a,b,c){var d={};d.load=function(b,c,d){var f=a.endpoint(b);return e(f,"/",c,d)};var e=function(c,d,e,h){return c.get(d,e).then(function(a){return a.response._embedded=a.response._embedded||{},a.response._links=a.response._links||{},a.response._links.self=a.response._links.self||{},a.response._links.self.type=a.response._links.self.type||a.header["Content-Type"],a.response._links.self.href=a.response._links.self.href||a.url,h(a.response),f(c,a.response._embedded,e,h).then(function(){return g(c,a.response._links,e,h)})})["catch"](function(e){b.error(a.logPrefix+"["+c.name+"] ["+d+"] Failed to load: ",e.status)})},f=function(a,b,d,e){var h=c.ensureArray(b&&b.item||[]),i=function(b){return b._links=b._links||{},b._links.self=b._links.self||{},b._links.self.type?(e(a,b,d),f(a,b._embedded,d,e).then(function(){return g(a,b._links,d,e)})):Promise.resolve()};return Promise.all(h.map(i))},g=function(d,f,g,h){var i=c.ensureArray(f&&f.item||[]),j=i.filter(function(b){return 0===c.object.values(a.data,function(a,c){return c.self=c.self||{},c.self.href===b.href}).length}),k=function(a){var c=g.slice(0);return a.type&&c.push({name:"Accept",value:a.type}),e(d,a.href,c,h)["catch"](function(c){b.info("failed to gather link: ",a.href," reason: ",c)})};return j.length&&b.info(a.logPrefix+" Processing "+j.length+" linked items."),Promise.all(j.map(k))};return d}(ozpIwc.api,ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.mutex=function(a){var b=function(a){if(a=a||{},!a.requester)throw"A mutex requires a requester.";var b=a.requester;if(!a.resource)throw"A resource is required to lock on.";return a.onUnlock&&a.requester.send({dst:"locks.api",action:"watch",resource:a.resource},function(c,d){c=c||{},c.entity=c.entity||{},c.entity.oldValue=c.entity.oldValue||{},c.entity.newValue=c.entity.newValue||{};var e=c.entity.oldValue.owner||{},f=c.entity.newValue.owner||{};e.src===b.address&&f.src!==b.address&&(a.onUnlock(c),d())}),a.requester.send({dst:"locks.api",action:"lock",resource:a.resource})};return b}(ozpIwc.util),function(a,b){"use strict";function c(a){return o[n]=d.apply(b,a),n++}function d(a){var c=[].slice.call(arguments,1);return function(){"function"==typeof a?a.apply(b,c):new Function(""+a)()}}function e(a){if(p)setTimeout(d(e,a),0);else{var b=o[a];if(b){p=!0;try{b()}finally{f(a),p=!1}}}}function f(a){delete o[a]}function g(){m=function(){var a=c(arguments);return process.nextTick(d(e,a)),a}}function h(){if(a.postMessage&&!a.importScripts){var b=!0,c=a.onmessage;return a.onmessage=function(){b=!1},a.postMessage("","*"),a.onmessage=c,b}}function i(){var b="setImmediate$"+Math.random()+"$",d=function(c){c.source===a&&"string"==typeof c.data&&0===c.data.indexOf(b)&&e(+c.data.slice(b.length))};a.addEventListener?a.addEventListener("message",d,!1):a.attachEvent("onmessage",d),m=function(){var d=c(arguments);return a.postMessage(b+d,"*"),d}}function j(){var a=new MessageChannel;a.port1.onmessage=function(a){var b=a.data;e(b)},m=function(){var b=c(arguments);return a.port2.postMessage(b),b}}function k(){var a=q.documentElement;m=function(){var b=c(arguments),d=q.createElement("script");return d.onreadystatechange=function(){e(b),d.onreadystatechange=null,a.removeChild(d),d=null},a.appendChild(d),b}}function l(){m=function(){var a=c(arguments);return setTimeout(d(e,a),0),a}}if(!a.setImmediate){var m,n=1,o={},p=!1,q=a.document,r=Object.getPrototypeOf&&Object.getPrototypeOf(a);r=r&&r.setTimeout?r:a,"[object process]"==={}.toString.call(a.process)?g():h()?i():a.MessageChannel?j():q&&"onreadystatechange"in q.createElement("script")?k():l(),r.setImmediate=m,r.clearImmediate=f}}(new Function("return this")());var ozpIwc=ozpIwc||{};ozpIwc.util=function(a){return a.setImmediate=function(b){a.globalScope.setImmediate(b)},a.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},a.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0},a.alert=function(a,b){this.alerts=this.alerts||{},this.alerts[a]?this.alerts[a].error=b:this.alerts[a]={error:b,silence:!1},this.alerts[a].silence||(this.alerts[a].silence=!0,ozpIwc.log.log(a,b))},a.ensureArray=function(a){
return Array.isArray(a)?a:[a]},a.ensureObject=function(a){return"object"==typeof a&&null!==a?a:{}},a.localStorageKey="ozp.iwc.transport.localStorage",a.getFormattedContentType=function(a){var b={};if("string"==typeof a){var c=a.split(";");if(c.length>0){b.name=c[0];for(var d=1;d<c.length;d++){var e=c[d].replace(" ","").split("=");if("name"!==e[0])try{b[e[0]]=JSON.parse(e[1])}catch(f){b[e[0]]=e[1]}}}}return b},a.genContentTypeMappings=function(b){var c={};for(var d in b){var e=b[d].serializedContentType;if(e){var f=a.getFormattedContentType(e);c[f.name]=c[f.name]||{},f.version?c[f.name][f.version]=b[d]:c[f.name]=b[d]}}return c},a}(ozpIwc.util||{});var ozpIwc=ozpIwc||{};ozpIwc.config=ozpIwc.config||{},ozpIwc.util.runningInWorker&&importScripts("ozpIwc.conf.js"),ozpIwc.config.version=ozpIwc.util.ifUndef(ozpIwc.util.ifUndef(ozpIwc.config.version||"1.0.10")),ozpIwc.config.logLevel=ozpIwc.util.ifUndef(ozpIwc.config.logLevel||6),ozpIwc.config.consensusTimeout=ozpIwc.util.ifUndef(ozpIwc.config.consensusTimeout||3e3),ozpIwc.config.heartBeatFrequency=ozpIwc.util.ifUndef(ozpIwc.config.heartBeatFrequency||2e4),ozpIwc.config.apiRootUrl=ozpIwc.util.ifUndef(ozpIwc.config.apiRootUrl||"/"),ozpIwc.config.policyRootUrl=ozpIwc.util.ifUndef(ozpIwc.config.policyRootUrl||"/policy"),ozpIwc.config.linkRelPrefix=ozpIwc.util.ifUndef(ozpIwc.config.linkRelPrefix||"ozp"),ozpIwc.config.intentsChooserUri=ozpIwc.util.ifUndef(ozpIwc.config.intentsChooserUri||"intentsChooser.html"),ozpIwc.config.legacySupport=ozpIwc.util.ifUndef(ozpIwc.config.legacySupport,!0),ozpIwc.config.backendSupport=ozpIwc.util.ifUndef(ozpIwc.config.backendSupport,!1),ozpIwc.config.defaultContentTypes=ozpIwc.util.ifUndef(ozpIwc.config.requiredContentType,{}),ozpIwc.config.defaultContentTypes["ozp:data-item"]=ozpIwc.util.ifUndef(ozpIwc.config.defaultContentTypes["ozp:data-item"],"application/vnd.ozp-iwc-data-object+json;version=2"),ozpIwc.config.runApis=ozpIwc.util.ifUndef(ozpIwc.config.runApis,!0),ozpIwc.config.allowLocalClients=ozpIwc.util.ifUndef(ozpIwc.config.allowLocalClients,!0),ozpIwc.config._testMode=ozpIwc.util.ifUndef(ozpIwc.config._testMode,!1),ozpIwc.config._busRoot=ozpIwc.util.ifUndef(ozpIwc.config._busRoot,function(){return ozpIwc.util.globalScope.location.protocol+"//"+ozpIwc.util.globalScope.location.host+ozpIwc.util.globalScope.location.pathname.replace(/[^\/]+$/,"")}()),ozpIwc.config.intentChooserFeatures=ozpIwc.util.ifUndef(ozpIwc.config.intentChooserFeatures,"width=330,height=500"),ozpIwc.config.owf7PrefsUrl=ozpIwc.util.ifUndef(ozpIwc.config.owf7PrefsUrl,"/owf/prefs"),ozpIwc.config.ajaxPoolSize=ozpIwc.util.ifUndef(ozpIwc.config.ajaxPoolSize,1),ozpIwc.config.templates=ozpIwc.util.ifUndef(ozpIwc.config.templates,{});var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.elements=ozpIwc.policyAuth.elements||{},ozpIwc.policyAuth.elements.SecurityAttribute=function(a){var b=function(a){a=a||{},this.attributes=a.attributes||{},this.comparator=a.comparator||this.comparator};return b.prototype.pushIfNotExist=function(b,c,d){if(d=d||this.comparator,c){var e=a.ensureArray(c);if(this.attributes[b])for(var f in e){var g=!0;for(var h in this.attributes[b])if(d(this.attributes[b][h],e[f])){g=!1;break}g&&this.attributes[b].push(e[f])}else this.attributes[b]=[],this.attributes[b]=this.attributes[b].concat(e)}},b.prototype.clear=function(a){delete this.attributes[a]},b.prototype.clearAll=function(){this.attributes={}},b.prototype.getAll=function(){return this.attributes},b.prototype.comparator=function(a,b){return a===b},b}(ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.points=ozpIwc.policyAuth.points||{},ozpIwc.policyAuth.points.PDP=function(a,b){var c=function(b){b=b||{},this.prp=b.prp||new a.PRP,this.pip=b.pip||new a.PIP,this.policySets=b.policySets||{connectSet:["policy://ozpIwc/connect"],apiSet:["policy://policy/apiNode"],readSet:["policy://policy/read"],receiveAsSet:["policy://policy/receiveAs"],sendAsSet:["policy://policy/sendAs"]}};return c.prototype.isPermitted=function(c){var d=new b.AsyncAction,e=this;if(!c)return d.resolve("success",{result:"Permit"});c.combiningAlgorithm=c.combiningAlgorithm||this.defaultCombiningAlgorithm;var f=function(a){d.resolve("failure",a)};return a.points.utils.formatRequest(c,this.pip).success(function(b){e.prp.getPolicies(b.policies).success(function(e){var g=a.PolicyCombining[b.combiningAlgorithm](e,b.category),h={result:g,request:c,formattedRequest:b};"Permit"===g?d.resolve("success",h):f(h)}).failure(f)}).failure(f),d},c.prototype.defaultCombiningAlgorithm="deny-overrides",c}(ozpIwc.policyAuth,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.points=ozpIwc.policyAuth.points||{},ozpIwc.policyAuth.points.PIP=function(a,b){var c=b.extend(a.elements.SecurityAttribute,function(b){a.elements.SecurityAttribute.apply(this,arguments)});return c.prototype.getAttributes=function(a){var c=new b.AsyncAction,d=this;return this.attributes[a]?c.resolve("success",d.attributes[a]):(b.ajax({href:a,method:"GET"}).then(function(e){if("object"!=typeof e)return c.resolve("failure","Invalid data loaded from the remote PIP");d.attributes[a]={};for(var f in e)d.attributes[a][f]=b.ensureArray(e[f]);c.resolve("success",d.attributes[a])})["catch"](function(a){c.resolve("failure",a)}),c)},c.prototype.grantAttributes=function(a,c){var d={};for(var e in c)d[e]=b.ensureArray(c[e]);this.attributes[a]=d},c.prototype.grantParent=function(a,c){var d=new b.AsyncAction;this.attributes[a]=this.attributes[a]||{};var e=this;if(e.attributes[c]){for(var f in e.attributes[c]){e.attributes[a][f]=e.attributes[a][f]||[];for(var g in e.attributes[c][f])e.attributes[a][f].indexOf(e.attributes[c][f][g])<0&&e.attributes[a][f].push(e.attributes[c][f][g])}return d.resolve("success",e.attributes[a])}return e.getAttributes(c).success(function(b){for(var c in b)e.attributes[a].indexOf(b[c])<0&&e.attributes[a].push(b[c]);d.resolve("success",e.attributes[a])}).failure(function(a){d.resolve("failure",a)}),d},c.prototype.combineAttributeValues=function(a,b,c){return[b,c]},c.prototype.attributeUnion=function(a,c){var d={};return b.object.eachEntry(a,function(a,b){Array.isArray(b)?d[a]=b.slice():d[a]=b}),b.object.eachEntry(c,function(a,b){a in d?Array.isArray(d[a])?d[a]=d[a].concat(b):d[a]=this.combineAttributeValues(d[a],b):d[a]=b},this),d},c}(ozpIwc.policyAuth,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.points=ozpIwc.policyAuth.points||{},ozpIwc.policyAuth.points.PRP=function(a,b){var c=function(b){b=b||{},this.persistentPolicies=b.persistentPolicies||[],this.policyCache=b.policyCache||a.policies};return c.prototype.getPolicies=function(c){var d=new b.AsyncAction;c=c||[],c=b.ensureArray(c);var e=[],f=this.persistentPolicies.concat(c);for(var g in f)if(this.policyCache[f[g]])e.push(b.clone(this.policyCache[f[g]]));else{var h=this.fetchPolicy(f[g]);e.push(h)}return 0===e.length?d.resolve("success",[a.policies.permitAll]):b.AsyncAction.all(e)},c.prototype.defaultCombiningAlgorithm="deny-overrides",c.prototype.fetchPolicy=function(a){var c=new b.AsyncAction,d=this;return b.ajax({method:"GET",href:a}).then(function(e){d.policyCache[a]=d.formatPolicy(e.response),c.resolve("success",b.clone(d.policyCache[a]))})["catch"](function(b){c.resolve("success",d.getDenyall(a))}),c},c.prototype.formatPolicy=function(b){return new a.Policy(b)},c.prototype.getDenyall=function(b){return this.policyCache[b]?this.policyCache[b]:(this.policyCache[b]=a.policies.denyAll,this.policyCache[b])},c}(ozpIwc.policyAuth,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.points=ozpIwc.policyAuth.points||{},ozpIwc.policyAuth.points.utils=function(a){var b=function(b,d){var e=new a.AsyncAction;if(!d)return e.resolve("failure","A PIP is required to format attributes.");b=a.ensureArray(b);var f=[];for(var g in b)f.push(c(b[g],d));return a.AsyncAction.all(f).success(function(a){var b={};for(var c in a)if(Object.keys(a[c]).length>0)for(var d in a[c])b[d]=a[c][d];e.resolve("success",b)}),e},c=function(c,d){var e=new a.AsyncAction;if(!d)return e.resolve("failure","A PIP is required to format attributes.");if(c)if("string"==typeof c)d.getAttributes(c).success(function(a){e.resolve("success",a)});else{if(Array.isArray(c))return b(c,d);if("object"==typeof c){var f=Object.keys(c);for(var g in f){var h=c[f[g]];["string","number","boolean"].indexOf(typeof c[f[g]])>=0&&(c[f[g]]=[h]),c[f[g]]=c[f[g]]||[]}e.resolve("success",c)}}else e.resolve("success",{});return e},d=function(a){var b=[],c=function(a,b){var c;return a["ozp:iwc:action"]&&(c=a["ozp:iwc:action"]),Array.isArray(c)?d(c,b):void(["string","number","boolean"].indexOf(typeof c)>=0&&b.indexOf(c)<0&&b.push(c))},d=function(a,b){for(var e in a)"string"==typeof a[e]?b.indexOf(a[e])<0&&b.push(a[e]):Array.isArray(a[e])?d(a[e],b):"object"==typeof a[e]&&c(a[e],b)};return a&&("string"==typeof a?b.push(a):Array.isArray(a)?d(a,b):"object"==typeof a&&c(a,b)),{"ozp:iwc:action":b}},e=function(b,e){var f=new a.AsyncAction;if(!e)return f.resolve("failure","A PIP is required to format requests.");if(b=b||{},b.subject=b.subject||{},b.resource=b.resource||{},b.action=b.action||{},!b.combiningAlgorithm)return f.resolve("failure","request.combiningAlgorithm is required to format requests.");var g=[],h=c(b.subject,e),i=c(b.resource,e),j=d(b.action);return g.push(h,i,j),a.AsyncAction.all(g).success(function(a){var c=a[0],d=a[1],e=a[2];f.resolve("success",{category:{subject:c,resource:d,action:e},combiningAlgorithm:b.combiningAlgorithm,policies:b.policies})}).failure(function(a){f.resolve("failure",a)}),f},f=function(b,d){var e=new a.AsyncAction;return d?b?(c(b,d).success(function(a){for(var b in a["ozp:iwc:permissions"])a[b]=a["ozp:iwc:permissions"][b];delete a["ozp:iwc:permissions"],e.resolve("success",a)}).failure(function(a){e.resolve("failure",a)}),e):e.resolve("success"):e.resolve("failure","A PIP is required to format requests.")},g=function(b,c){var d=new a.AsyncAction;if(!c)return d.resolve("failure","A PIP is required to format requests.");var e=[],g={};for(var h in b)e.push(f(b[h],c)),g[h]=e.length-1;return a.AsyncAction.all(e).success(function(a){var b={},c=Object.keys(g);for(var e in c)b[c[e]]=a[g[c[e]]]||{};d.resolve("success",b)}).failure(function(a){d.resolve("failure",a)}),d};return{formatAttribute:c,formatAttributes:b,formatAction:d,formatRequest:e,formatCategory:f,formatCategories:g}}(ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.policies=function(a,b){var c=function(c,d){return d=b.ensureArray(d),b.arrayContainsAll(d,c.action["ozp:iwc:action"])?b.objectContainsAll(c.subject,c.resource,a.implies)?"Permit":"Deny":"NotApplicable"};return a.permitWhenObjectHasNoAttributes=function(a){return a.object&&0===Object.keys(a.object).length?"Permit":"Undetermined"},a.subjectHasAllObjectAttributes=function(a){if(!a.object)return"Permit";var c=a.subject||{};return b.objectContainsAll(c,a.object,this.implies)?"Permit":"Deny"},a.permitAll=function(){return"Permit"},a.denyAll=function(){return"Deny"},a.implies=function(a,c){return void 0===c||null===c?!0:void 0===a||null===a?!1:(a=b.ensureArray(a),c=b.ensureArray(c),b.arrayContainsAll(a,c))},a["policy://ozpIwc/connect"]=function(a){var c=["connect"];return b.arrayContainsAll(c,a.action["ozp:iwc:action"])?"Permit":"NotApplicable"},a["policy://policy/sendAs"]=function(a){return c(a,"sendAs")},a["policy://policy/receiveAs"]=function(a){return c(a,"receiveAs")},a["policy://policy/read"]=function(a){return c(a,"read")},a["policy://policy/apiNode"]=function(a){return c(a,"access")},a}(ozpIwc.policyAuth.policies||{},ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PolicyCombining=function(a){return a["deny-overrides"]=function(a,b){var c,d,e,f=!1;for(var g in a){var h=a[g](b);switch(h){case"Deny":return"Deny";case"Permit":f=!0;break;case"NotApplicable":continue;case"Indeterminate{D}":c=!0;break;case"Indeterminate{P}":d=!0;break;case"Indeterminate{DP}":e=!0;break;default:continue}}return e?"Indeterminate{DP}":c&&(d||f)?"Indeterminate{DP}":c?"Indeterminate{D}":f?"Permit":d?"Indeterminate{P}":"NotApplicable"},a["permit-overrides"]=function(){},a["first-applicable"]=function(){},a["only-one-applicable"]=function(){},a["ordered-deny-overrides"]=function(){},a["ordered-permit-overrides"]=function(){},a["deny-unless-permit"]=function(){},a["permit-unless-deny"]=function(){},a}(ozpIwc.policyAuth.PolicyCombining||{});var ozpIwc=ozpIwc||{};ozpIwc.network=ozpIwc.network||{},ozpIwc.network.KeyBroadcastLocalStorageLink=function(a,b){var c=function(c){if(c=c||{},!c.peer)throw Error("KeyBroadcastLocalStorageLink must be configured with a peer");this.prefix=c.prefix||"ozpIwc",this.peer=c.peer,this.selfId=c.selfId||this.peer.selfId,this.metrics=c.metrics,this.metrics&&(this.metricsPrefix="keyBroadcastLocalStorageLink."+this.selfId,this.droppedFragmentsCounter=this.metrics.counter(this.metricsPrefix,"fragmentsDropped"),this.fragmentsReceivedCounter=this.metrics.counter(this.metricsPrefix,"fragmentsReceived"),this.packetsSentCounter=this.metrics.counter(this.metricsPrefix,"packetsSent"),this.packetsReceivedCounter=this.metrics.counter(this.metricsPrefix,"packetsReceived"),this.packetParseErrorCounter=this.metrics.counter(this.metricsPrefix,"packetsParseError"),this.packetsFailedCounter=this.metrics.counter(this.metricsPrefix,"packetsFailed"),this.latencyInTimer=this.metrics.timer(this.metricsPrefix,"latencyIn"),this.latencyOutTimer=this.metrics.timer(this.metricsPrefix,"latencyOut")),this.myKeysTimeout=c.myKeysTimeout||5e3,this.otherKeysTimeout=c.otherKeysTimeout||12e4,this.maxRetries=c.maxRetries||6,this.queueSize=c.queueSize||1024,this.sendQueue=this.sendQueue||[],this.fragments=this.fragments||[],this.fragmentSize=c.fragmentSize||1310720,this.fragmentTimeout=c.fragmentTimeout||1e3,String.prototype.chunk=function(a){for(var b=[],c=0;c<this.length;c+=a)b.push(this.slice(c,c+a));return b};var e,f=this,g=function(c){if(c.key===b.localStorageKey&&c.newValue){try{e=JSON.parse(c.newValue)}catch(g){return a.error("Parse error on "+c.newValue),void(f.metrics&&f.packetParseErrorCounter.inc())}e.data.fragment?f.handleFragment(e):d(f,e)}};b.getInternetExplorerVersion()>=0?setTimeout(function(){b.addEventListener("storage",g)},500):b.addEventListener("storage",g),this.peer.on("send",function(a){f.send(a.packet)}),this.peer.on("beforeShutdown",function(){b.removeEventListener("storage",g)},this)},d=function(a,c){a.peer.receive(a.linkId,c),a.metrics&&a.packetsReceivedCounter.inc(),c.data.time&&a.metrics&&a.latencyInTimer.mark(b.now()-c.data.time)},e=function(a,b){if(!b.data.fragment)return null;var c=b.sequence,d=b.srcPeer,e=b.data.msgId,f=b.data.id,g=b.data.chunk,h=b.data.total;return void 0===e||void 0===f?null:(a.fragments[e]||(a.fragments[e]={},a.fragments[e].chunks=[],a.key=e,a.total=h,a.fragments[e].timeoutFunc=function(){a.metrics&&a.droppedFragmentsCounter.inc(a.total),delete a.fragments[a.key]}),clearTimeout(a.fragments[e].fragmentTimer),a.fragments[e].fragmentTimer=setTimeout(a.fragments[e].timeoutFunc,a.fragmentTimeout),a.fragments[e].total=h||a.fragments[e].total,a.fragments[e].sequence=void 0!==c?c:a.fragments[e].sequence,a.fragments[e].srcPeer=d||a.fragments[e].srcPeer,a.fragments[e].chunks[f]=g,void 0===a.fragments[e].total||void 0===a.fragments[e].sequence||void 0===a.fragments[e].srcPeer?null:(a.metrics&&a.fragmentsReceivedCounter.inc(),!0))},f=function(a){if(a.total!==a.chunks.length)return null;try{var b=JSON.parse(a.chunks.join(""));return{defragmented:!0,sequence:a.sequence,srcPeer:a.srcPeer,data:b}}catch(c){return null}},g=function(b,c){if(b.sendQueue.length<b.queueSize)for(b.sendQueue=b.sendQueue.concat(c);b.sendQueue.length>0;)h(b,b.sendQueue.shift());else b.metrics&&b.packetsFailedCounter.inc(),a.error("Failed to write packet(len="+c.length+"): Send queue full.")},h=function(b,c,d){var e=b.sendImpl(c);if(e){d=d||0;var f=Math.max(1,Math.pow(2,d-1))-1;if(!(d<b.maxRetries))return b.metrics&&b.packetsFailedCounter.inc(),a.error("Failed to write packet(len="+c.length+"):"+e),e;d++,setTimeout(function(){h(b,c,d)},f)}};return c.prototype.handleFragment=function(a){if(!this.peer.haveSeen(a)){var b=a.data.msgId;e(this,a);var c=f(this.fragments[b]);if(c){clearTimeout(this.fragments[b].fragmentTimer);var g=this.peer.packetsSeen[c.srcPeer].indexOf(c.sequence);delete this.peer.packetsSeen[c.srcPeer][g],d(this,c),delete this.fragments[b]}}},c.prototype.send=function(b){var c;try{c=JSON.stringify(b.data)}catch(d){this.metrics&&this.packetsFailedCounter.inc();var e=b.msgId||"unknown";return void a.error("Failed to write packet(msgId="+e+"):"+d.message)}if(c.length<this.fragmentSize)g(this,b);else{var f=c.chunk(this.fragmentSize),h=this;h.data=b.data,delete b.data;for(var i=function(a,b){return b.sequence=h.peer.sequenceCounter++,b.data={fragment:!0,msgId:h.data.msgId,id:j,total:f.length,chunk:a},b},j=0;j<f.length;j++)g(this,i(f[j],b))}},c.prototype.sendImpl=function(a){var c;try{var d=JSON.stringify(a);localStorage.setItem(b.localStorageKey,d),this.metrics&&this.packetsSentCounter.inc(),a.data.time&&this.metrics&&this.latencyOutTimer.mark(b.now()-a.data.time),localStorage.removeItem(b.localStorageKey),c=null}catch(e){"localStorage is null"===e.message?b.alert("Cannot locate localStorage. Contact your system administrator.",e):18===e.code?b.alert("Ozone requires your browser to accept cookies. Contact your system administrator.",e):c=e}finally{return c}},c}(ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.network=ozpIwc.network||{},ozpIwc.network.Peer=function(){var a=function(a){a=a||{},this.selfId=ozpIwc.util.generateId(),this.metricPrefix="peer."+this.selfId,this.sequenceCounter=0,this.packetsSeen={},this.knownPeers={},this.metrics=a.metrics,this.events=new ozpIwc.util.Event,this.events.mixinOnOff(this);var b=this;this.unloadListener=function(){b.shutdown()},ozpIwc.util.addEventListener("beforeunload",this.unloadListener)};return a.maxSeqIdPerSource=500,a.prototype.haveSeen=function(a){if(a.srcPeer===this.selfId)return this.metrics&&this.metrics.counter(this.metricPrefix,"droppedOwnPacket").inc(),!0;var b=this.packetsSeen[a.srcPeer];return b||(b=this.packetsSeen[a.srcPeer]=[]),b.indexOf(a.sequence)>=0?!0:(b.unshift(a.sequence),b.length>=ozpIwc.network.Peer.maxSeqIdPerSource&&(b.length=ozpIwc.network.Peer.maxSeqIdPerSource),!1)},a.prototype.send=function(a){var b={srcPeer:this.selfId,sequence:this.sequenceCounter++,data:a},c=new ozpIwc.util.CancelableEvent({packet:b});this.events.trigger("preSend",c),c.canceled?this.metrics&&this.metrics.counter(this.metricPrefix,"sendRejected").inc():(this.metrics&&this.metrics.counter(this.metricPrefix,"sent").inc(),this.metrics&&a.time&&this.metrics.timer(this.metricPrefix,"latencyOut").mark(ozpIwc.util.now()-a.time),this.events.trigger("send",{packet:b}))},a.prototype.receive=function(a,b){return this.haveSeen(b)?void(this.metrics&&this.metrics.counter(this.metricPrefix,"dropped").inc()):(this.metrics&&this.metrics.counter(this.metricPrefix,"received").inc(),this.metrics&&b.data.time&&this.metrics.timer(this.metricPrefix,"latencyIn").mark(ozpIwc.util.now()-b.data.time),void this.events.trigger("receive",{packet:b,linkId:a}))},a.prototype.shutdown=function(){this.events.trigger("beforeShutdown"),ozpIwc.util.removeEventListener("beforeunload",this.unloadListener)},a}(ozpIwc);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.Base=function(a,b,c,d){var e=function(a){if(a=a||{},!a.authorization)throw Error("Participant must be configured with an authorization module");this.events=new d.Event,this.events.mixinOnOff(this),this.permissions=new b.elements.SecurityAttribute,this.msgId=0,this.metrics=a.metrics,this.authorization=a.authorization,this.participantType=this.constructor.name,this.heartBeatContentType="application/vnd.ozp-iwc-address-v1+json",this.heartBeatStatus={name:this.name,type:this.participantType||this.constructor.name},this.replyCallbacks={};var e=this;d.addEventListener("beforeunload",function(){e.send=function(a,b){var d=this.fixPacket(a);return b&&(e.replyCallbacks[d.msgId]=b),c.participant.Base.prototype.send.call(e,d),d},e.leaveEventChannel()})};return e.prototype.verifyReceiveAs=function(a){var b={subject:this.permissions.getAll(),resource:{"ozp:iwc:receiveAs":a.packet.dst},action:{"ozp:iwc:action":"receiveAs"},policies:this.authorization.policySets.receiveAsSet};return this.authorization.isPermitted(b)},e.prototype.formatRequest=function(a){return b.points.utils.formatCategory(a.packet.permissions,this.authorization.pip)},e.prototype.verifyRead=function(a){var b={subject:this.permissions.getAll(),resource:a||{},action:{"ozp:iwc:action":"read"},policies:this.authorization.policySets.readSet};return this.authorization.isPermitted(b)},e.prototype.verifySendAs=function(a){var b={subject:this.permissions.getAll(),resource:{"ozp:iwc:sendAs":a.src},action:{"ozp:iwc:action":"sendAs"},policies:this.authorization.policySets.sendAsSet};return this.authorization.isPermitted(b)},e.prototype.markReceivePacket=function(a){this.metrics&&(this.receivedPacketsMeter.mark(),a.packet.time&&this.latencyInTimer.mark(d.now()-a.packet.time))},e.prototype.markSendPacket=function(a){this.metrics&&(this.sentPacketsMeter.mark(),a.time&&this.latencyOutTimer.mark(d.now()-a.time))},e.prototype.receiveFromRouter=function(b){function c(b){d.metrics&&(d.forbiddenPacketsMeter.mark(),d.metrics.counter("transport.packets.forbidden").inc()),a.error("failure",b)}var d=this;this.verifyReceiveAs(b).success(function(){d.formatRequest(b).success(function(a){d.verifyRead(a).success(function(){d.markReceivePacket(b),d.receiveFromRouterImpl(b)}).failure(c)}).failure(c)}).failure(c)},e.prototype.receiveFromRouterImpl=function(a){return!a},e.prototype.connectToRouter=function(a,b){this.address=b,this.router=a,this.msgId=0,this.name?this.metricRoot="participants."+this.name+"."+this.address.split(".").reverse().join("."):this.metricRoot="participants."+this.address.split(".").reverse().join("."),this.metrics&&(this.sentPacketsMeter=this.metrics.meter(this.metricRoot,"sentPackets").unit("packets"),this.receivedPacketsMeter=this.metrics.meter(this.metricRoot,"receivedPackets").unit("packets"),this.forbiddenPacketsMeter=this.metrics.meter(this.metricRoot,"forbiddenPackets").unit("packets"),this.latencyInTimer=this.metrics.timer(this.metricRoot,"latencyIn").unit("packets"),this.latencyOutTimer=this.metrics.timer(this.metricRoot,"latencyOut").unit("packets")),this.namesResource="/address/"+this.address,this.heartBeatStatus.address=this.address,this.heartBeatStatus.name=this.name,this.heartBeatStatus.type=this.participantType||this.constructor.name,this.events.trigger("connectedToRouter"),this.joinEventChannel()},e.prototype.fixPacket=function(a){return a.src=a.src||this.address,a.ver=a.ver||1,a.msgId=a.msgId||this.generateMsgId(),a.time=a.time||d.now(),a},e.prototype.send=function(b){function c(c){a.error("Participant "+d.address+" failed to send a packet:",c,b)}var d=this;return b=d.fixPacket(b),this.verifySendAs(b).success(function(){d.markSendPacket(b),d.router.send(b,d)}).failure(c),b},e.prototype.generateMsgId=function(){return"i:"+this.msgId++},e.prototype.heartbeat=function(){if(this.router){var a=this.heartBeatStatus;return a.time=d.now(),this.fixPacket({dst:"names.api",resource:this.namesResource,action:"set",entity:a,contentType:this.heartBeatContentType,respondOn:"none"})}},e.prototype.joinEventChannel=function(){return this.router?(this.router.registerMulticast(this,["$bus.multicast"]),this.send({dst:"$bus.multicast",action:"connect",entity:{address:this.address,participantType:this.participantType}}),!0):!1},e.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),!0):!1},e.prototype.destroy=function(){this.router&&this.router.participants[this.address]&&delete this.router.participants[this.address]},e}(ozpIwc.log,ozpIwc.policyAuth,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.Internal=function(a,b){var c=b.extend(a.participant.Base,function(b){b=b||{},a.participant.Base.apply(this,arguments),this.replyCallbacks={},this.participantType="internal",this.name=b.name;var c=this;this.on("connectedToRouter",function(){c.permissions.pushIfNotExist("ozp:iwc:address",c.address),c.permissions.pushIfNotExist("ozp:iwc:sendAs",c.address),c.permissions.pushIfNotExist("ozp:iwc:receiveAs",c.address),c.metrics&&c.metrics.gauge(c.metricRoot,"registeredCallbacks").set(function(){return d(c)})})}),d=function(a){return a.replyCallbacks&&Object.keys(a.replyCallbacks)?Object.keys(a.replyCallbacks).length:0},e=function(a,b){var c=!1;return b&&(delete a.replyCallbacks[b],c=!0),c};return c.prototype.receiveFromRouterImpl=function(a){var b=a.packet;if(b.replyTo&&this.replyCallbacks[b.replyTo]){var c=!1,d=function(){c=!0};this.replyCallbacks[b.replyTo](b,d),c&&e(this,b.replyTo)}else this.events.trigger("receive",a)},c.prototype.send=function(b,c){var d=this.fixPacket(b);c&&(this.replyCallbacks[d.msgId]=c);var e=this,f=a.participant.Base.prototype.send;return f.call(e,d),d},c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.SharedWorker=function(a,b,c){var d=c.extend(b.participant.Base,function(a){b.participant.Base.apply(this,arguments),this.origin=this.name=a.origin,this.port=a.port,this.credentials=a.credentials,this.readyPromise=a.ready||Promise.resolve(),this.participantType="postMessageProxy",this.permissions.pushIfNotExist("ozp:iwc:origin",this.origin),this.on("connectedToRouter",function(){this.permissions.pushIfNotExist("ozp:iwc:address",this.address),this.permissions.pushIfNotExist("ozp:iwc:sendAs",this.address),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",this.address)},this),this.heartBeatStatus.origin=this.origin;var d=this,e=function(a){var b=a.data;if("string"==typeof b)try{b=JSON.parse(a.data)}catch(a){}b&&b.windowEvent&&d.handleWindowEvent(b.windowEvent),d.forwardFromMessageChannel(b,a)};this.port.addEventListener("message",e,!1),c.safePostMessage(this.port,{iwcInit:!0})});return d.prototype.handleTransportPacket=function(a){var b={ver:1,dst:this.address,src:"$transport",replyTo:a.msgId,msgId:this.generateMsgId(),entity:{address:this.address}},c=this;this.readyPromise.then(function(){c.sendToRecipient(b)})},d.prototype.receiveFromRouterImpl=function(a){this.sendToRecipient(a.packet)},d.prototype.sendToRecipient=function(a){c.safePostMessage(this.port,a)},d.prototype.forwardFromMessageChannel=function(b,c){var d=b.proxyAs||{};return"object"!=typeof b?void a.error("Unknown packet received: "+JSON.stringify(b)):d.origin!==this.origin?(this.metrics&&this.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc(),void a.error("Message sender does not match this worker's application origin.","This worker's origin: [",this.origin,"] cannot accept sender origin: [",d.origin,"]")):(b=this.fixPacket(b),void("$transport"===b.dst?this.handleTransportPacket(b):this.router.send(b,this)))},d.prototype.handleWindowEvent=function(a){switch(a){case"beforeunload":this.leaveEventChannel(),this.destroy()}},d}(ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.PostMessage=function(a,b,c){var d=c.extend(b.participant.Base,function(a){b.participant.Base.apply(this,arguments),this.origin=this.name=a.origin,this.source=a.source,this.credentials=a.credentials,this.readyPromise=a.ready||Promise.resolve(),this.participantType="postMessageProxy",this.permissions.pushIfNotExist("ozp:iwc:origin",this.origin),this.on("connectedToRouter",function(){this.permissions.pushIfNotExist("ozp:iwc:address",this.address),this.permissions.pushIfNotExist("ozp:iwc:sendAs",this.address),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",this.address)},this),this.heartBeatStatus.origin=this.origin,c.safePostMessage(this.source,{iwcInit:!0})});return d.prototype.handleTransportPacket=function(a){var b={ver:1,dst:this.address,src:"$transport",replyTo:a.msgId,msgId:this.generateMsgId(),entity:{address:this.address}},c=this;this.readyPromise.then(function(){c.sendToRecipient(b)})},d.prototype.receiveFromRouterImpl=function(a){this.sendToRecipient(a.packet)},d.prototype.sendToRecipient=function(a){c.safePostMessage(this.source,a,this.origin)},d.prototype.forwardFromPostMessage=function(b,c){return"object"!=typeof b?void a.error("Unknown packet received: "+JSON.stringify(b)):c.origin!==this.origin?void(this.metrics&&this.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc()):(b=this.fixPacket(b),void("$transport"===b.dst?this.handleTransportPacket(b):this.router.send(b,this)))},d}(ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.Router=function(a,b,c,d){var e=function(b){if(b=b||{},!b.peer)throw Error("Router must be configured with a peer");if(!b.authorization)throw Error("Router must be configured with an authorization module");this.peer=b.peer;var e=this;this.selfId=d.generateId(),this.participants={},this.metrics=b.metrics,this.metrics&&this.metrics.gauge("transport.participants").set(function(){return Object.keys(e.participants).length}),this.authorization=b.authorization,this.events=new d.Event,this.events.mixinOnOff(this),this.peer.on("receive",function(a){e.receiveFromPeer(a.packet)});var f=function(a){var b=a.packet;1!==b.ver&&a.cancel("badVersion"),b.src||a.cancel("nullSource"),b.dst||a.cancel("nullDestination"),a.canceled&&e.metrics&&e.metrics.counter("transport.packets.invalidFormat").inc()};this.events.on("preSend",f),b.disableBus||(this.participants["$bus.multicast"]=new c.participant.Multicast({authorization:this.authorization,name:"$bus.multicast"})),this.watchdog=new c.participant.RouterWatchdog({authorization:b.authorization,router:this,heartbeatFrequency:b.heartbeatFrequency||a.heartBeatFrequency,autoConnect:!1}),this.registerParticipant(this.watchdog),this.recursionDepth=0,this.metrics&&this.metrics.gauge("transport.router.participants").set(function(){return e.getParticipantCount()})};return e.prototype.getParticipantCount=function(){return this.participants&&Object.keys(this.participants)?Object.keys(this.participants).length:0},e.prototype.shutdown=function(){this.watchdog.shutdown()},e.prototype.registerParticipant=function(a,c){c=c||{};var e;do e=d.generateId()+"."+this.selfId;while(this.participants.hasOwnProperty(e));var f=new d.CancelableEvent({packet:c,registration:c.entity,participant:a});if(this.events.trigger("preRegisterParticipant",f),f.canceled)return b.info("registeredParticipant[DENIED] origin:"+a.origin+" because "+f.cancelReason),null;this.participants[e]=a,a.connectToRouter(this,e),this.send(a.heartbeat(),a);var g=new d.CancelableEvent({packet:c,participant:a});return this.events.trigger("registeredParticipant",g),e},e.prototype.deliverLocal=function(a,e){if(!a)throw"Cannot deliver a null packet!";var f=this.participants[a.dst];if(f){this.recursionDepth++,this.recursionDepth>10&&b.log("Recursing more than 10 levels deep on ",a);try{var g=new c.PacketContext({packet:a,router:this,srcParticipant:e,dstParticipant:f}),h=new d.CancelableEvent({packet:a,dstParticipant:f,srcParticipant:e});if(this.events.trigger("preDeliver",h).canceled)return void(this.metrics&&this.metrics.counter("transport.packets.rejected").inc());
this.metrics&&this.metrics.counter("transport.packets.delivered").inc(),f.receiveFromRouter(g)}finally{this.recursionDepth--}}},e.prototype.registerMulticast=function(a,e){var f=this;return e.forEach(function(e){var g=f.participants[e];if(g||(g=f.participants[e]=new c.participant.Multicast({name:e,authorization:f.authorization})),g.addMember(a),a.address){var h=new d.CancelableEvent({entity:{group:e,address:a.address}});a.permissions.pushIfNotExist("ozp:iwc:sendAs",e),a.permissions.pushIfNotExist("ozp:iwc:receiveAs",e),f.events.trigger("registeredMulticast",h)}else b.info("no address for "+a.participantType+" "+a.name+"with address "+a.address+" for group "+e)}),e},e.prototype.send=function(a,b){var c=new d.CancelableEvent({packet:a,participant:b});return this.events.trigger("preSend",c),c.canceled?void(this.metrics&&this.metrics.counter("transport.packets.sendCanceled")):(this.metrics&&this.metrics.counter("transport.packets.sent").inc(),this.deliverLocal(a,b),this.events.trigger("send",{packet:a}),void this.peer.send(a))},e.prototype.receiveFromPeer=function(a){var b=Date.now();this.metrics&&(this.metrics.counter("transport.packets.receivedFromPeer").inc(),this.metrics.histogram("transport.packets.latency").mark(b-a.data.time,b));var c=new d.CancelableEvent({packet:a.data,rawPacket:a});this.events.trigger("prePeerReceive",c),c.canceled||this.deliverLocal(a.data)},e}(ozpIwc.config,ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.consensus=ozpIwc.transport.consensus||{},ozpIwc.transport.consensus.Base=function(a,b){var c=function(c){c=c||{};var d=this;if(!c.name)throw"Consensus module expects a name.";if(!c.router)throw"Consensus module expects a router.";this.name=c.name,this.participant=c.participant||new a.participant.Client({internal:!0,router:c.router,authorization:c.authorization,name:c.name}),this.consensusAddress=c.consensusAddress||this.name+".consensus",this.router=c.router,this.events=new b.Event,this.events.mixinOnOff(this),this.state="unknown",this.participant.on("connectedToRouter",function(){d.participant.permissions.pushIfNotExist("ozp:iwc:address",[d.participant.address,d.consensusAddress]),d.participant.permissions.pushIfNotExist("ozp:iwc:sendAs",[d.participant.address,d.consensusAddress]),d.participant.permissions.pushIfNotExist("ozp:iwc:receiveAs",[d.participant.address,d.consensusAddress])}),this.routePacket=c.routePacket||this.routePacket,this.router.registerMulticast(this.participant,[this.consensusAddress]),this.participant.on("receive",this.routePacket,this)};return c.prototype.routePacket=function(a){throw"routePacket is to be overridden by consensus implementation"},c.prototype.onBecomeCoordinator=function(){throw"onBecomeCoordinator is to be overridden by consensus implementation"},c.prototype.onBecomeMember=function(){throw"onBecomeMember is to be overridden by consensus implementation"},c.prototype.changeState=function(a){this.state!==a&&(this.state=a,this.events.trigger("changedState",this.state))},c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.consensus=ozpIwc.transport.consensus||{},ozpIwc.transport.consensus.Bully=function(a,b,c){var d=c.extend(a.Base,function(d){a.Base.apply(this,arguments),this.consensusId=d.consensusId||-c.now(),this.coordinatorTimeoutHeartbeat=d.heartbeat||b.consensusTimeout,this.coordinatorIntervalHeartbeat=this.coordinatorTimeoutHeartbeat/2,this.gatherLogs=d.gatherLogs||function(){};var e=this;c.addEventListener("beforeunload",function(){e.shutdown(),e.events.trigger("shutdown")}),k(this),f(this)});d.prototype.routePacket=function(a){var b=a.packet||{};if(b.dst===this.consensusAddress&&b.src!==this.participant.address)switch(b.action){case"election":g(this,b);break;case"acknowledge":h(this,b);break;case"victory":i(this,b);break;case"query":j(this,b)}},d.prototype.sendElectionMessage=function(){this.participant.send({dst:this.consensusAddress,action:"election",entity:{consensusId:this.consensusId},respondOn:"none"})};var e=function(a){var b=a.gatherLogs()||a.logs;a.participant.send({dst:a.consensusAddress,action:"victory",entity:{consensusId:a.consensusId,logs:b},respondOn:"none"})},f=function(a){a.participant.send({dst:a.consensusAddress,action:"query",entity:{consensusId:a.consensusId},respondOn:"none"})},g=function(a,b){var c=b.entity;if(!c.consensusId)throw"Non-formatted election message received.";var d=c.consensusId;return c.logs&&(a.logs=c.logs),d>a.consensusId?(m(a),void k(a)):(l(a),void k(a))},h=function(a,b){var c=b.entity,d=c.replyTo||{};if(!d.consensusId)throw"Non-formatted acknowledge message received.";var e=d.consensusId;e===a.consensusId&&m(a)},i=function(a,b){var c=b.entity;if(!c.consensusId)throw"Non-formatted election message received.";var d=c.consensusId;return c.logs&&(a.logs=c.logs||a.logs),d>a.consensusId?(c.logs&&(a.events.trigger("receivedLogs",c.logs),a.logs=void 0),m(a),void k(a)):void l(a)},j=function(a,b){var c=b.entity;if(!c.consensusId)throw"Non-formatted election message received.";return a.coordinatorInterval?void e(a):void 0},k=function(a,b,c){b=b||a.coordinatorTimeoutHeartbeat,clearTimeout(a.coordinatorTimeout),c||a.changeState("member"),a.coordinatorTimeout=setTimeout(function(){a.onCoordinatorTimeout()},b)};d.prototype.onCoordinatorTimeout=function(){l(this)},d.prototype.onBecomeCoordinator=function(){var a=this;clearTimeout(this.coordinatorTimeout),clearInterval(this.coordinatorInterval),e(this),this.changeState("coordinator"),this.coordinatorInterval=setInterval(function(){e(a)},this.coordinatorIntervalHeartbeat)},d.prototype.shutdown=function(){("coordinator"===this.state||this.logs)&&(this.consensusId=-Number.MAX_VALUE,e(this))};var l=function(a,b){b=b||2*a.coordinatorTimeoutHeartbeat/3,clearTimeout(a.electionTimeout),a.electionTimeout=setTimeout(function(){a.onBecomeCoordinator()},b),a.sendElectionMessage()},m=function(a){clearTimeout(a.electionTimeout)};return d}(ozpIwc.transport.consensus,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.listener=ozpIwc.transport.listener||{},ozpIwc.transport.listener.Base=function(a,b,c){var d=function(a){if(a=a||{},!a.router)throw"Listener requires a router.";this.participants=[],this.router=a.router,this.authorization=a.authorization,this.metrics=a.metrics,this.readyPromise=a.ready||Promise.resolve();var b=this;this.registration(),this.metrics&&this.metrics.gauge("transport.listener."+this.name+".participants").set(function(){return b.getParticipantCount()})};return d.prototype.name="Base",d.prototype.registration=function(){throw"Listener registration should be overriden by inheriting class."},d.prototype.getParticipantCount=function(){return this.participants?this.participants.length:0},d.prototype.findParticipant=function(a){for(var b=0;b<this.participants.length;++b)if(this.participants[b].source===a)return this.participants[b]},d}(ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.listener=ozpIwc.transport.listener||{},ozpIwc.transport.listener.PostMessage=function(a,b,c){var d=c.extend(b.listener.Base,function(a){b.listener.Base.apply(this,arguments)});d.prototype.name="PostMessage";var e=function(b,d,e){c.isIWCPacket(d)?b.forwardFromPostMessage(d,e):a.debug("Packet does not meet IWC Packet criteria, dropping.",d)},f=function(a,c,d){var e,f=d.type||"default",g={authorization:a.authorization,origin:c.origin,source:c.source,router:a.router,credentials:d.entity,ready:a.readyPromise};switch(f.trim().toLowerCase()){case"debugger":e=new b.participant.PMDebugger(g);break;case"default":e=new b.participant.PostMessage(g)}return e&&!e.invalid?(a.router.registerParticipant(e,d),a.participants.push(e),e):void 0},g=function(a,b){var c={subject:{"ozp:iwc:origin":b.origin},action:{"ozp:iwc:action":"connect"},policies:a.authorization.policySets.connectSet};return a.authorization.isPermitted(c)};return d.prototype.registration=function(){var b=this;c.addEventListener("message",function(d){var h=b.findParticipant(d.source),i=d.data;if(d.source!==c.globalScope){if("string"==typeof d.data)try{i=JSON.parse(d.data)}catch(j){return}h?e(h,i,d):g(b,d).success(function(){h=f(b,d,i),h&&e(h,i,d)}).failure(function(b){a.error("Failed to connect. Could not authorize:",b)})}})},d}(ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.listener=ozpIwc.transport.listener||{},ozpIwc.transport.listener.SharedWorker=function(a,b,c){var d=c.extend(b.listener.Base,function(a){b.listener.Base.apply(this,arguments)});d.prototype.name="SharedWorker",d.prototype.registration=function(){c.addEventListener("connect",e(this),!1)};var e=function(a){return function(b){var c=b.ports[0],d={authorization:a.authorization,router:a.router,port:c,ready:a.readyPromise};c.addEventListener("message",f(a,c,d)),c.start()}},f=function(a,c,d){return function e(f){if(f.data&&"string"==typeof f.data.type){var g=f.data.type.trim();d.origin=f.data.proxyAs.origin.trim();var h;switch(g.toLowerCase()){case"debugger":h=new b.participant.SWDebugger(d);break;default:h=new b.participant.SharedWorker(d)}h&&!h.invalid&&(a.router.registerParticipant(h),a.participants.push(h))}c.removeEventListener("message",e)}};return d}(ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.PacketContext=function(a){var b=function(a){for(var b in a)this[b]=a[b]};b.prototype.makeReplyTo=function(a){var b=(new Date).getTime();return a.ver=a.ver||1,a.time=a.time||b,a.replyTo=a.replyTo||this.packet.msgId,a.src=a.src||this.packet.dst,a.dst=a.dst||this.packet.src,a.respondOn=a.respondOn||"none",a},b.prototype.replyTo=function(b){return c(this,b)?(b=this.makeReplyTo(b),this.dstParticipant?this.dstParticipant.send(b):(b.msgId=b.msgId||a.now(),this.router.send(b)),b):void 0};var c=function(a,b){switch(a.packet=a.packet||{},a.packet.respondOn=a.packet.respondOn||"all",a.packet.respondOn){case"none":return!1;case"error":return/(bad|no).*/.test(b.response);default:return!0}};return b}(ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.Client=function(a,b){var c=b.extend(a.participant.Base,function(c){if(c=c||{},!c.router)throw"Client Participant requires a router.";a.participant.Base.apply(this,arguments),this.participantType="internalClient",this.internal=c.internal||!1,this.name=c.name,this.metrics=c.metrics,this.router=c.router;var d=this;this.on("connectedToRouter",function(){d.permissions.pushIfNotExist("ozp:iwc:address",d.address),d.permissions.pushIfNotExist("ozp:iwc:sendAs",d.address),d.permissions.pushIfNotExist("ozp:iwc:receiveAs",d.address),this.metrics&&this.metrics.gauge(d.metricRoot,"registeredCallbacks").set(function(){return d.replyCallbacks&&Object.keys(d.replyCallbacks)?Object.keys(d.replyCallbacks).length:0})}),b.ApiPromiseMixin(this,c.autoConnect)});return c.prototype.connect=function(){if(!this.connectPromise){var a=this;this.connectPromise=new Promise(function(b,c){b(a.router.registerParticipant(a))}).then(function(b){return a.afterConnected(b)})}return this.connectPromise},c.prototype.sendImpl=a.participant.Base.prototype.send,c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.wiring=ozpIwc.wiring||{},ozpIwc.transport.participant=function(a,b,c,d,e,f){var g=function(c){var g=e.extend(c,function(b){var d=e.getOrigin();if(b.origin!==d){var f="Debugger participants are only permitted on Bus-domain applications. Debugger creation attempted from Application-domain: ["+b.origin+"] while Bus-domain is: ["+d+"]";return a.error(f),this.invalid=!0,void e.safePostMessage(b.port,{iwcInit:!0,error:f})}c.apply(this,arguments),this.name="DebuggerParticipant",this.router=b.router,this.peer=this.router.peer;var g=this;this.logging={enabled:!1,watchList:{},notifyListeners:function(a){for(var b in g.logging.watchList)h(g,{response:"changed",replyTo:g.logging.watchList[b].msgId,entity:a})}},this.on("receive",this.handleReceivePacket)}),h=function(a,b){b=b||{},b.src=b.src||a.address,b.response=b.response||"ok",b=a.fixPacket(b),a.sendToRecipient(b)},i=function(a,b){switch(b.action.trim().toLowerCase()){case"start":j(a,b);break;case"stop":k(a,b)}},j=function(a,b){a.logging.watchList[b.msgId]=b,a.logging.enabled||(a.logging.enabled=!0,a.peer.on("receive",a.logging.notifyListeners),a.peer.on("send",a.logging.notifyListeners)),h(a,{replyTo:b.msgId})},k=function(a,b){b=b||{},b.entity=b.entity||{},b.entity.msgId&&a.logging.watchList[b.entity.msgId]&&delete a.logging.watchList[b.entity.msgId],a.logging.enabled&&0===Object.keys(a.logging.watchList).length&&(a.logging.enabled=!1,a.peer.off("receive",a.logging.notifyListeners),a.peer.off("send",a.logging.notifyListeners)),h(a,{replyTo:b.msgId})},l=function(a,b){switch(b.action.trim().toLowerCase()){case"getendpoints":m(a,b)}},m=function(a,b){var c=f.endpointInitPromise||Promise.resolve();c.then(function(){var c=[];for(var d in f.apis){var e=f.apis[d];for(var g in e.endpoints){var i=e.endpoints[g],j=ozpIwc.api.endpoint(i.link);c.push({name:e.name,rel:j.name,path:j.baseUrl})}}h(a,{replyTo:b.msgId,entity:c})})},n=function(a,b){switch(b.action.trim().toLowerCase()){case"getall":o(a,b)}},o=function(a,b){var c=f.metrics.allMetrics();for(var d in c)c[d].value=c[d].get();h(a,{replyTo:b.msgId,entity:c})},p=function(a,b){switch(b.action.trim().toLowerCase()){case"getall":q(a,b)}},q=function(a,c){h(a,{replyTo:c.msgId,entity:b})};return g.prototype.handleReceivePacket=function(a,b){if("string"!=typeof a.resource)return void d.participant.SharedWorker.prototype.handleTransportPacket.call(this,a);switch(a.resource.trim().toLowerCase()){case"metrics":n(this,a);break;case"traffic":i(this,a);break;case"apis":l(this,a);break;case"config":p(this,a)}},g.prototype.receiveFromRouterImpl=function(a){a.packet.src===a.packet.dst?this.handleReceivePacket(a.packet):this.sendToRecipient(a.packet)},g};return c.SWDebugger=g(c.SharedWorker),c.PMDebugger=g(c.PostMessage),c}(ozpIwc.log,ozpIwc.config,ozpIwc.transport.participant||{},ozpIwc.transport,ozpIwc.util,ozpIwc.wiring);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.Multicast=function(a,b){var c=b.extend(a.participant.Base,function(b){this.address=b.name,this.name=b.name,this.participantType="multicast",a.participant.Base.apply(this,arguments),this.members=[],this.namesResource="/multicast/"+this.name,this.heartBeatContentType="application/vnd.ozp-iwc-multicast-address-v1+json",this.heartBeatStatus.members=[],this.on("connectedToRouter",function(){this.namesResource="/multicast/"+this.name},this),this.permissions.pushIfNotExist("ozp:iwc:address",b.name),this.permissions.pushIfNotExist("ozp:iwc:sendAs",b.name),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",b.name)});return c.prototype.receiveFromRouterImpl=function(a){return this.metrics&&this.receivedPacketsMeter.mark(),this.members.forEach(function(b){a.dstParticipant=b,b.receiveFromRouter(a)}),!1},c.prototype.addMember=function(a){this.members.push(a),this.heartBeatStatus.members.push(a.address)},c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.MutexClient=function(a,b){var c=b.extend(a.participant.Client,function(b){if(b=b||{},!b.name)throw"Cannot instantiate a MutexClient without a name.";a.participant.Client.apply(this,arguments),this.participantType="MutexClient",this.onLock=b.onLock||function(){},this.onRelease=b.onRelease||function(){},d(this)});c.prototype.leaveEventChannel=function(){return this.events.trigger("shutdown"),this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),!0):!1},c.prototype.relock=function(){this.lockPromise||d(this)};var d=function(a){a.lockPromise||(a.lockPromise=b.mutex({requester:a,resource:"/mutex/"+a.name,onUnlock:function(){a.lockPromise=void 0,a.onRelease()}}).then(a.onLock))};return c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.transport=ozpIwc.transport||{},ozpIwc.transport.participant=ozpIwc.transport.participant||{},ozpIwc.transport.participant.RouterWatchdog=function(a,b){var c=b.extend(a.participant.Client,function(b){a.participant.Client.apply(this,arguments),this.internal=!0,this.participantType="routerWatchdog",this.heartbeatFrequency=b.heartbeatFrequency||1e4,this.on("connectedToRouter",d,this);var c=this;this.on("beforeunload",function(){c.leaveEventChannel()})});c.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.router.selfId,namesResource:"/router/"+this.router.selfId}}),!0):!1};var d=function(){this.name=this.router.selfId;var c=this,d=function(){var d=[],e=c.names().messageBuilder.set("/router/"+c.router.selfId,{contentType:"application/vnd.ozp-iwc-router-v1+json",entity:{address:c.router.selfId,participants:c.router.getParticipantCount(),time:b.now()},respondOn:"none"});d.push(e);for(var f in c.router.participants){var g=c.router.participants[f];g.heartBeatStatus.time=b.now(),g instanceof a.participant.Multicast?g.members.forEach(function(a){e=c.names().messageBuilder.set(g.namesResource+"/"+a.address,{entity:a.heartBeatStatus,contentType:g.heartBeatContentType,respondOn:"none"}),d.push(e)}):d.push({packet:g.heartbeat(),callback:void 0,res:function(){},rej:function(){}})}c.names().bulkSend(d)};this.timer=setInterval(d,this.heartbeatFrequency),d()};return c.prototype.shutdown=function(){clearInterval(this.timer)},c}(ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api=function(a){return a.initEndpoints=function(b){b=b||{};var c=new a.EndpointRegistry(b);return a.endpoint=function(a){return c.endpoint(a)},a.uriTemplate=function(a){return c.template[a]},a.endpointPromise=c.loadPromise,a.endpointPromise},a.createApi=function(b,c){var d=ozpIwc.util.extend(a.base.Api,function(){var d=arguments[0];return d.name=d.name||b,a.base.Api.apply(this,[d]),c.apply(this,arguments)});return ozpIwc.util.PacketRouter.mixin(d),d.useDefaultRoute=function(b,c){c=c||"{resource:.*}",b=ozpIwc.util.ensureArray(b),b.forEach(function(b){var e=a.filter.standard.forAction(b);d.declareRoute({action:b,resource:c,filters:e?e():[]},a.base.Api.defaultHandler[b])})},d.declareRoute({action:["bulkSend"],resource:"{resource:.*}",filters:[]},function(a,b,c){var d=a.entity||[];return d.forEach(function(a){var b=new ozpIwc.transport.PacketContext({packet:a.packet,router:this.router,srcParticipant:a.packet.src,dstParticipant:this.address});this.receivePacketContext(b)},this),{response:"ok"}}),d},a}(ozpIwc.api);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.Lifespan=function(a){return a.getLifespan=function(a,b){if(b&&b.lifespan){if("string"==typeof b.lifespan){var c=b.lifespan;b.lifespan={type:c}}if(b.lifespan.type){var d=b.lifespan;if(d.type=d.type.charAt(0).toUpperCase()+d.type.slice(1),"Bound"===d.type){if(!d.addresses){if(!b.src)return;d.addresses=[b.src]}a.lifespan&&"Bound"===a.lifespan.type&&(a.lifespan.addresses=a.lifespan.addresses||[],a.lifespan.addresses.forEach(function(a){-1===d.addresses.indexOf(a)&&d.addresses.push(a)}))}return d}}},a.getLifespanFunctionality=function(b){switch(b.type){case"Ephemeral":return a.ephemeralFunctionality;case"Persistent":return a.persistentFunctionality;case"Bound":return a.boundFunctionality;default:throw new Error("Received a malformed Lifespan, resource will be dropped: ",b)}},a.ephemeralFunctionality={shouldPersist:function(){return!1},shouldDelete:function(){return!1}},a.persistentFunctionality={shouldPersist:function(){return!0},shouldDelete:function(){return!1}},a.boundFunctionality={shouldPersist:function(){return!1},shouldDelete:function(a,b){var c=b.length;return a.addresses=a.addresses||[],a.addresses=a.addresses.filter(function(a){return a.substr(-c)!==b}),0===a.addresses.length}},a.Persistent=function(){this.type="Persistent"},a.Ephemeral=function(){this.type="Ephemeral"},a.Bound=function(a){a=a||{},this.type="Bound",this.addresses=a.addresses||[]},a}(ozpIwc.api.Lifespan||{});var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.Endpoint=function(a){var b=function(a){this.endpointRegistry=a,this.ajaxQueue=a.ajaxQueue},c=function(a){return a.replace(/ /g,"")},d=function(a,b,d){if(a=a.replace(/ /g,""),0===d.length)d.push({name:"Accept",value:a});else{var e=function(b){return b.replace(/ /g,"")!==a};for(var f in d)if("Accept"===d[f].name)if(d[f].value){var g=d[f].value.split(",").map(c),h=g.filter(e);h.unshift(a),d[f].value=h.join(",")}else d[f].value=a}return d},e=function(a,b){if(0===b.length)b.push({name:"Accept",value:a.type});else for(var d in b)if("Accept"===b[d].name)if(b[d].value){var e=b[d].value.split(",").map(c);-1===e.indexOf(a.type)&&e.push(a.type),b[d].value=e.join(",")}else b[d].value=a.type;return b},f=function(a,b,c){c=c||[];var f=a.findContentType(b);return f&&(c=d(f,a,c)),a.type&&(c=e(a,c)),c};return b.prototype.get=function(a,b){var c=this;return a=a||"",this.endpointRegistry.loadPromise.then(function(){var d=f(c,a,b);if(!c.endpointRegistry.loaded)throw Error("Endpoint "+c.endpointRegistry.apiRoot+" could not be reached. Skipping GET of "+a);return"/"!==a&&""!==a||(a=c.baseUrl),a?c.ajaxQueue.queueAjax({href:a,method:"GET",headers:d}):Promise.reject("no url assigned to endpoint "+c.name)})},b.prototype.put=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),d.ajaxQueue.queueAjax({href:a,method:"PUT",data:b,headers:c})})},b.prototype["delete"]=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){if(!d.baseUrl)throw Error("The server did not define a relation of type "+this.name+" for retrivieving "+a);return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),d.ajaxQueue.queueAjax({href:a,method:"DELETE",headers:c})})},b.prototype.saveNodes=function(a){var b="/data";for(var c in a){var d=JSON.stringify(a[c]);this.put(a[c].self||b,d)}},b.prototype.findContentType=function(a){for(var b in this.endpointRegistry.template){var c=this.endpointRegistry.template[b].isMatch(a)||this.endpointRegistry.template[b].isMatch(a.substring(a.indexOf(ozpIwc.config.apiRootUrl)));if(c)return this.endpointRegistry.template[b].type}},b}(ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.EndpointRegistry=function(a,b,c){var d=function(c){if(c=c||{},!c.ajaxQueue)throw"Endpoints require AjaxPersistenceQueue.";var d=c.apiRoot||"/api";this.apiRoot=d,this.ajaxQueue=c.ajaxQueue,this.endPoints={},this.template={};var f=this;this.loadPromise=this.ajaxQueue.queueAjax({href:d,method:"GET"}).then(function(b){f.loaded=!0;var d=b.response||{};d._links=d._links||{},d._embedded=d._embedded||{};for(var g in d._links)if("self"!==g){var h=d._links[g];Array.isArray(d._links[g])&&(h=d._links[g][0].href),h.templated?e(f,{name:g,type:h.type,href:h.href}):(f.endpoint(g).baseUrl=h.href,f.endpoint(g).type=h.type)}for(var i in d._embedded){var j=d._embedded[i]._links.self;f.endpoint(i).baseUrl=j.href,f.endpoint(i).type=j.type}for(var k in c.templates){var l=ozpIwc.config.templates[k],m=!1;if(l.endpoint&&l.pattern){var n=f.endpoint(l.endpoint).baseUrl;n&&(m=n+l.pattern)}m||(m=l.href),e(f,{name:k,href:m,type:l.type})}var o=f.endpoint("ozp:user-data").baseUrl;!f.template["ozp:data-item"]&&o&&e(f,{name:"ozp:data-item",href:o+"/{+resource}",type:a.data.node.Node.serializedContentType}),f.template["ozp:application-item"]||e(f,{name:"ozp:application-item",href:f.endpoint().endpointRegistry.apiRoot+"/listing/{+resource}",type:a.system.node.ApplicationNode.serializedContentType})})["catch"](function(a){b.debug(Error("Endpoint "+f.apiRoot+" "+a.statusText+". Status: "+a.status)),f.loaded=!1})},e=function(a,b){b=b||{},"string"==typeof b.href&&(a.template[b.name]={href:b.href,type:b.type,isMatch:c.PacketRouter.uriTemplate(b.href)})};return d.prototype.endpoint=function(b){var c=this.endPoints[b];return c||(c=this.endPoints[b]=new a.Endpoint(this),c.name=b),c},d}(ozpIwc.api,ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.base=ozpIwc.api.base||{},ozpIwc.api.base.Api=function(a,b,c,d){var e=function(a){var b=this;if(!a.name)throw Error("API must be configured with a name");if(!a.router)throw Error("API must be configured with a router");if(!a.authorization)throw Error("API must be configured with an authorization module");this.authorization=a.authorization,this.name=a.name,this.coordinationAddress="coord."+this.name,this.events=new d.Event,this.events.mixinOnOff(this),this.endpoints=[],this.data={},this.watchers={},this.collectors=[],this.changeList={},this.leaderState="member",this.participant=a.participant||new c.participant.MutexClient({internal:!0,router:a.router,authorization:a.authorization,name:a.name,onLock:function(){b.onLock()},onRelease:function(){b.onRelease()}}),this.participant.on("receive",this.receivePacketContext,this),this.participant.on("shutdown",this.shutdown,this),this.router=a.router,this.router.registerMulticast(this.participant,[this.name,this.coordinationAddress]),this.logPrefix="["+this.name+"/"+this.participant.address+"] ",this.ajaxQueue=a.ajaxQueue,this.transitionToMemberReady()};e.prototype.initializeData=function(a){var c=!a;if(a=a||{watchers:{},collectors:[],data:[]},this.watchers=a.watchers,this.collectors=a.collectors,a.data.forEach(function(a){var b=a.self||{};this.createNode({resource:a.resource,contentType:b.type}).deserializeLive(a)},this),this.updateCollections(),c&&this.endpoints){var e=this,f=function(a){e.loadedResourceHandler(a)};return Promise.all(this.endpoints.map(function(a){return d.halLoader.load(a.link,a.headers,f)["catch"](function(a){b.error(e.logPrefix,"load from endpoint failed. Reason: ",a)})}))}return Promise.resolve()},e.prototype.loadedResourceHandler=function(a){a=a||{},a._links=a._links||{};var c=a._links.self||{},d=this.findNodeType(c.type);if(d)try{this.createNode({serializedEntity:a,contentType:c.type},d)}catch(e){b.info(this.logPrefix+"["+c.type+"] ["+c.href+"] No node created from resource, reason: ",e.message)}else b.info(this.logPrefix+"["+c.type+"] ["+c.href+"] No node created from resource, reason: no node type for this content-type.")},e.prototype.createDeathScream=function(){return{watchers:this.watchers,collectors:this.collectors,data:d.object.eachEntry(this.data,function(a,b){return b.serializeLive()}),timestamp:d.now()}},e.prototype.shutdown=function(){"leader"===this.leaderState?this.broadcastDeathScream(this.createDeathScream()):"member"===this.leaderState&&this.deathScream&&this.broadcastDeathScream(this.deathScream),this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"unlock"})},e.prototype.createKey=function(a){a=a||"";var b;do b=a+d.generateId();while(b in this.data);return b},e.prototype.onNodeCreated=function(a){this.updateCollections()},e.prototype.onNodeChanged=function(b,c,d){var e=a.Lifespan.getLifespanFunctionality(b.lifespan);e.shouldPersist()&&this.ajaxQueue&&this.ajaxQueue.queueNode(this.name+"/"+b.resource,b)},e.prototype.getPreference=function(a){return this.participant.send({dst:"data.api",resource:"/ozp/iwc/"+this.name+"/"+a,action:"get"}).then(function(a){return a.entity})},e.prototype.findNodeType=function(a){},e.prototype.createNode=function(a,b){b=b||this.findNodeType(a.contentType);var c=this.createNodeObject(a,b);return c?(this.data[c.resource]=c,this.events.trigger("createdNode",c),c):void 0},e.prototype.createNodeObject=function(b,c){return c?new c(b):new a.base.Node(b)},e.prototype.onLock=function(){this.transitionToLoading().then(this.transitionToLeader.bind(this)).then(this.onStart.bind(this))["catch"](function(a){b.error("Error registering for leader mutex [address="+this.participant.address+",api="+this.name+"]",a),this.shutdown()})},e.prototype.onRelease=function(){this.onStop(),this.transitionFromLeader(),this.participant.relock()},e.prototype.onStart=function(){},e.prototype.onStop=function(){},e.prototype.transitionToLoading=function(){return"member"!==this.leaderState?Promise.reject(this.logPrefix+"transition to loading called in an invalid state:",this.leaderState):(b.debug(this.logPrefix+"transitioning to loading"),this.leaderState="loading",this.initializeData(this.deathScream))},e.prototype.transitionToLeader=function(){return"loading"!==this.leaderState?Promise.reject(this.logPrefix+"transition to loading called in an invalid state:",this.leaderState):(b.debug(this.logPrefix+"transitioning to leader"),this.deathScream=void 0,this.leaderState="leader",this.broadcastLeaderReady(),this.deliverRequestQueue(),f(this),b.info(this.logPrefix+" Now operating"),Promise.resolve())},e.prototype.transitionFromLeader=function(){if("leader"!==this.leaderState)return Promise.reject(this.logPrefix+"transition to loading called in an invalid state:",this.leaderState);b.debug(this.logPrefix+"relinquishing leadership.");var a=this.createDeathScream();return this.broadcastDeathScream(a),this.leaderState="member",this.transitionToMemberReady(a)},e.prototype.transitionToMemberReady=function(a){return"member"===this.leaderState?(this.deathScream=a,g(this),this.enableRequestQueue(),Promise.resolve()):void 0},e.prototype.transitionToMemberDormant=function(){return"member"===this.leaderState?(this.deathScream=void 0,this.flushRequestQueue(),Promise.resolve()):void 0},e.prototype.broadcastLeaderReady=function(){this.participant.send({dst:this.coordinationAddress,action:"announceLeader"})},e.prototype.broadcastDeathScream=function(a){this.participant.send({dst:this.coordinationAddress,action:"deathScream",entity:a})},e.prototype.checkAuthorization=function(a,b,c,d){return!0},e.prototype.matchingNodes=function(a){return d.object.values(this.data,function(b,c){return 0===c.resource.indexOf(a)&&!c.deleted})},e.prototype.getCollectionResources=function(a){return this.getCollectionData(a).map(function(a){return a.resource})},e.prototype.getCollectionData=function(a){return this.collectors.indexOf(a.resource)>-1?this.matchingNodes(a.pattern).filter(function(a){return!a.deleted}):[]},e.prototype.markForChange=function(){for(var a=0;a<arguments.length;++a)if(Array.isArray(arguments[a]))this.markForChange(arguments[a]);else{var b=arguments[a].resource||""+arguments[a];if(this.changeList.hasOwnProperty(b))continue;var c=this.data[b];this.changeList[b]=c?c.snapshot():{}}},e.prototype.addWatcher=function(a,b){var c=this.watchers[a];Array.isArray(c)||(c=this.watchers[a]=[]),c.push(b)},e.prototype.removeWatcher=function(a,b){var c=this.watchers[a];c&&(this.watchers[a]=c.filter(function(a){return!(a.src===b.src&&a.replyTo===b.msgId)}))},e.prototype.addCollector=function(a){var b=this.collectors.indexOf(a.resource);0>b&&this.collectors.push(a.resource),j(this,a)},e.prototype.removeCollector=function(a){var b=this.collectors.indexOf(a.resource);b>-1&&this.collectors.splice(b,1)},e.prototype.updateCollections=function(){for(var a in this.collectors){var b=this.data[this.collectors[a]];j(this,b)}},e.prototype.send=function(a){return a.src=this.name,this.participant.send(a)},e.prototype.receivePacketContext=function(a){return a.packet.dst===this.coordinationAddress?l(this,a):m(this,a)},e.prototype.defaultRoute=function(b,c){switch(c.defaultRouteCause){case"nonRoutablePacket":return;case"noAction":throw new a.error.BadActionError(b);
case"noResource":throw new a.error.BadResourceError(b);default:throw new a.error.BadRequestError(b)}},e.prototype.enableRequestQueue=function(){this.isRequestQueueing=!0,this.requestQueue=[]},e.prototype.deliverRequestQueue=function(a){a=a||0,this.isRequestQueueing=!1,console.log("DELIVERING QUEUE:",this.name,this.requestQueue),this.requestQueue.forEach(function(b){b.packet.time>a&&m(this,b)},this),this.requestQueue=[]},e.prototype.flushRequestQueue=function(){console.log("FLUSHING QUEUE:",this.name,this.requestQueue),this.isRequestQueueing=!1,this.requestQueue=[]},e.prototype.enableSendQueue=function(){this.isSendQueueing=!0,this.sendQueue=[]},e.prototype.deliverSendQueue=function(){this.isSendQueueing=!1,this.sendQueue.forEach(this.participant.send,this.participant),this.sendQueue=[]},e.prototype.flushSendQueue=function(){this.isSendQueueing=!1,this.sendQueue=[]},e.prototype.onClientDisconnect=function(b){k(this,b);var c=this;d.object.eachEntry(c.data,function(d,e){var f=a.Lifespan.getLifespanFunctionality(e.lifespan);f.shouldDelete(e.lifespan,b)&&(c.markForChange(e),e.markAsDeleted())}),i(this)},e.prototype.onClientConnect=function(a){};var f=function(a){a.on("createdNode",a.onNodeCreated,a),a.on("changed",a.onNodeChanged,a),a.participant.on("addressDisconnects",a.onClientDisconnect,a),a.participant.on("addressConnects",a.onClientConnect,a)},g=function(a){a.off("createdNode",a.onNodeCreated),a.off("changed",a.onNodeChanged),a.participant.off("addressDisconnects",a.onClientDisconnect),a.participant.off("addressConnects",a.onClientConnect)},h=function(a,b,c,d){var e=a.data[b],f=a.watchers[b]||[];if(e){var g=e.changesSince(c);if(g){var h=a.authorization.pip.attributeUnion(g.oldValue.permissions,g.newValue.permissions),i={oldValue:g.oldValue.entity,newValue:g.newValue.entity,oldCollection:g.oldValue.collection,newCollection:g.newValue.collection,deleted:e.deleted};a.events.trigger("changed",e,i,d),f.forEach(function(b){a.participant.send({src:a.participant.name,dst:b.src,replyTo:b.replyTo,response:"changed",respondOn:"none",resource:e.resource,permissions:h,contentType:e.contentType,entity:i})})}}},i=function(a,b){a.updateCollections(),d.object.eachEntry(a.changeList,function(c,d){h(a,c,d,b)}),a.changeList={}},j=function(a,b){if(b){if(b.deleted)return void a.removeCollector(b.resource);var c=a.matchingNodes(b.pattern).filter(function(a){return!a.deleted}).map(function(a){return a.resource});b.collection=b.collection||[],d.arrayContainsAll(b.collection,c)&&d.arrayContainsAll(c,b.collection)||(a.markForChange(b),b.collection=c,b.version++)}},k=function(a,b){var c=b.length;d.object.eachEntry(a.watchers,function(a,d){for(var e in d)d[e].src.substr(-c)===b&&d.splice(e,1)})},l=function(a,c){var d=c.packet;switch(d.action){case"announceLeader":return a.transitionToMemberDormant();case"deathScream":return a.transitionToMemberReady(d.entity);default:return b.error("Unknown coordination packet: ",d),Promise.reject(new Error("Unknown action: "+d.action+" in "+JSON.stringify(c)))}},m=function(a,c){var d=c.packet;if(a.isRequestQueueing)return void a.requestQueue.push(c);if("leader"===a.leaderState)try{c.node=a.data[d.resource];var e=a.routePacket(d,c);e&&(e.response=e.response||"ok",c.replyTo(e)),i(a,c)}catch(f){f&&f.errorAction||b.error(a.logPrefix,"Unexpected error: ",f," packet= ",d);var g={src:a.name,response:f.errorAction||"errorUnknown",entity:f.message};c.replyTo(g)}};return e}(ozpIwc.api,ozpIwc.log,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.base=ozpIwc.api.base||{},ozpIwc.api.base.Node=function(a,b,c){var d=function(b){b=b||{},this.resource=b.resource,this.allowedContentTypes=b.allowedContentTypes,this.entity=b.entity,this.contentType=b.contentType||d.serializedContentType,b.uriTemplate&&(this.uriTemplate=b.uriTemplate),this.permissions={},this.version=b.version||1;var c=a.Lifespan.getLifespan(this,b);if(c?("Bound"!==c.type||c.addresses||(c.addresses=[b.src]),this.lifespan=c):this.lifespan=new a.Lifespan.Ephemeral,this.deleted=!1,this.pattern=b.pattern,this.collection=[],this.self=b.self||{},this.self.type=this.self.type||this.contentType,b.serializedEntity&&this.deserialize(b.serializedEntity,b.contentType),!this.resource)throw new Error("Base Node requires a resource")};return d.prototype.getSelfUri=function(){if(this.self&&this.self.href)return this.self;if(this.uriTemplate&&a.uriTemplate){var b=a.uriTemplate(this.uriTemplate);if(b)return this.self={href:c.resolveUriTemplate(b.href,this),type:b.type},this.self}},d.prototype.serializeLive=function(){return this.toPacket({deleted:this.deleted,contentType:this.contentType,pattern:this.pattern,collection:this.collection,lifespan:this.lifespan,allowedContentTypes:this.allowedContentTypes,self:this.self})},d.prototype.deserializeLive=function(a,b){a.contentType=a.contentType||b,this.set(a),a._links&&a._links.self&&(this.self=a._links.self),this.resource||(this.resource=a.resource||this.resourceFallback(a)),this.self=a.self||a._links.self||this.self,this.deleted=a.deleted,this.lifespan=a.lifespan,this.allowedContentTypes=a.allowedContentTypes,this.pattern=a.pattern,this.collection=a.collection},d.prototype.deserializeResourceFromContentType=function(a){a._links&&a._links.self&&(this.resource=a._links.self.href.replace(b.apiRootUrl,""))},d.prototype.serialize=function(){return JSON.stringify({entity:this.entity,resource:this.resource,self:this.self})},d.serializedContentType="application/json",d.prototype.deserialize=function(a,b){"string"==typeof a&&(a=JSON.parse(a)),a=a||{},a._links=a._links||{},this.self=a.self||a._links.self||this.self,this.contentType=b,this.pattern=a.pattern,this.version=a.version||this.version,this.permissions=a.permissions||{},this.collection=a.collection||[],this.entity=this.deserializedEntity(a,b),this.resource||this.useIwcSelf()||(this.resource=this.resourceFallback(a))},d.prototype.deserializedEntity=function(a){return a.entity},d.prototype.useIwcSelf=function(){return this.self["ozp:iwcSelf"]?(this.resource=this.self["ozp:iwcSelf"].href.replace(/web\+ozp:\/\/[^\/]+/,""),!0):void 0},d.prototype.resourceFallback=function(a){return a.resource},d.prototype.toPacket=function(a){return a=a||{},a.entity=c.clone(this.entity),a.lifespan=this.lifespan,a.contentType=this.contentType,a.permissions=this.permissions,a.eTag=this.version,a.resource=this.resource,a.pattern=this.pattern,a.collection=this.collection,a},d.prototype.set=function(b){if(!Array.isArray(b.permissions))for(var d in b.permissions)this.permissions.clear(d),this.permissions.pushIfNotExist(d,b.permissions[d]);this.lifespan=a.Lifespan.getLifespan(this,b)||this.lifespan,this.contentType=b.contentType||this.contentType,this.entity=c.ifUndef(b.entity,this.entity),this.pattern=b.pattern||this.pattern,this.deleted=!1,b.eTag?this.version=b.eTag:this.version++},d.prototype.markAsDeleted=function(a){this.version++,this.deleted=!0,this.entity=void 0,this.pattern=void 0,this.collection=void 0},d.prototype.addWatch=function(a){this.watchers.push(a)},d.prototype.removeWatch=function(a){this.watchers=this.watchers.filter(a)},d.prototype.snapshot=function(){return this.toPacket()},d.prototype.changesSince=function(a){return a.eTag===this.version?null:{newValue:this.toPacket(),oldValue:a}},d}(ozpIwc.api,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.base=ozpIwc.api.base||{},ozpIwc.api.base.Api=function(a){return a.defaultHandler={get:function(a,b,c){var d=b.node.toPacket();return d.collection=this.getCollectionResources(d),d},set:function(a,b,c){return b.node.set(a),{response:"ok",entity:b.node.entity}},"delete":function(a,b,c){return b.node&&(b.node.markAsDeleted(a),this.removeCollector(b.node)),{response:"ok"}},list:function(a,b,c){var d=a.pattern||a.resource;b.node&&(d=b.node.pattern);var e=this.matchingNodes(d).filter(function(a){return!a.deleted}).map(function(a){return a.resource});return{contentType:"application/json",entity:e}},bulkGet:function(a,b,c){var d=this,e=this.matchingNodes(a.resource).map(function(a){var b=a.toPacket();return b.collection=d.getCollectionResources(b),b});return{contentType:"application/json",entity:e}},collect:function(a,b,c){this.addCollector(b.node);var d=b.node.toPacket();return d.entity=this.getCollectionData(b.node),d},watch:function(a,b,c){return this.addWatcher(a.resource,{src:a.src,replyTo:a.msgId}),b.node?b.node.toPacket():{response:"ok"}},unwatch:function(a,b,c){return this.removeWatcher(a.resource,a),this.watchers[a.resource]&&0===this.watchers[a.resource].length&&this.removeCollector(a.resource),{response:"ok"}}},a.allActions=Object.keys(a.defaultHandler),a}(ozpIwc.api.base.Api||{});var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.error=ozpIwc.api.error||{},ozpIwc.api.error.BaseError=function(a){var b=a.extend(Error,function(a,b){Error.call(this,b),this.name="ApiError",this.errorAction=a,this.message=b});return b.prototype.toString=function(){return this.name+":"+JSON.stringify(this.message)},b.subclass=function(c){return a.extend(b,function(a){b.call(this,c,a),this.name=c+"Error"})},b}(ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.error=ozpIwc.api.error||{},ozpIwc.api.error=function(a){return a.BadActionError=a.BaseError.subclass("badAction"),a.BadResourceError=a.BaseError.subclass("badResource"),a.BadRequestError=a.BaseError.subclass("badRequest"),a.BadContentError=a.BaseError.subclass("badContent"),a.BadStateError=a.BaseError.subclass("badState"),a.NoActionError=a.BaseError.subclass("noAction"),a.NoResourceError=a.BaseError.subclass("noResource"),a.NoMatchError=a.BaseError.subclass("noMatch"),a.NoPermissionError=a.BaseError.subclass("noPermission"),a}(ozpIwc.api.error);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.filter=ozpIwc.api.filter||{},ozpIwc.api.filter.base=function(a,b){var c={createResource:function(b){return b?function(a,c,d,e){return c.node?c.node.deleted&&c.node.set({resource:a.resource,pattern:a.pattern,lifespan:a.lifespan,src:a.src}):c.node=this.data[a.resource]=new b({resource:a.resource,pattern:a.pattern,lifespan:a.lifespan,src:a.src}),e()}:function(b,c,d,e){if(c.node||(c.node=this.createNode({resource:b.resource,contentType:b.contentType,pattern:b.pattern,lifespan:b.lifespan,src:b.src})),!c.node)throw new a.error.BadContentError({provided:b.contentType});return e()}},checkCollect:function(){return function(a,b,c,d){var e=a.pattern;return e||(e="/"===a.resource?a.resource:a.resource?a.resource+"/":"/"),b.node&&a.pattern?b.node.pattern!==a.pattern&&b.node.set({pattern:a.pattern}):b.node&&!b.node.pattern&&b.node.set({pattern:e}),!b.node&&a.collect&&(b.node=this.createNode({resource:a.resource,pattern:e})),a.collect&&this.addCollector(b.node),d()}},requireResource:function(){return function(b,c,d,e){if(!c.node||c.node.deleted)throw new a.error.NoResourceError(b);return e()}},checkAuthorization:function(a){return function(b,c,d,e){return this.checkAuthorization(c.node,c,b,a||b.action),e()}},nullFilter:function(a,b,c,d){return d()},checkContentType:function(d){return d?(d=b.ensureArray(d),function(b,c,e,f){if(!d.some(function(a){return a===b.contentType||"[object RegExp]"===Object.prototype.toString.call(d)&&a.test(b.contentType)}))throw new a.error.BadContentError({provided:b.contentType,allowedTypes:d});return f()}):c.nullFilter},markResourceAsChanged:function(){return function(a,b,c,d){return this.markForChange(a),d()}},fixPattern:function(){return function(a,b,c,d){var e;return b.node&&(e=b.node.pattern),a.resource&&(a.pattern=a.pattern||e||a.resource+"/"),d()}},checkVersion:function(){return function(b,c,d,e){if(b.ifTag&&b.ifTag!==c.node.version)throw new a.error.NoMatchError({expectedVersion:b.ifTag,actualVersion:c.node.version});return e()}}};return c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.filter=ozpIwc.api.filter||{},ozpIwc.api.filter.standard=function(a){var b={forAction:function(a){return b[a+"Filters"]},setFilters:function(b,c){return[a.base.checkAuthorization(),a.base.createResource(b),a.base.checkContentType(c),a.base.checkVersion(),a.base.checkCollect(),a.base.markResourceAsChanged()]},deleteFilters:function(){return[a.base.checkAuthorization(),a.base.checkVersion(),a.base.markResourceAsChanged()]},getFilters:function(){return[a.base.requireResource(),a.base.checkAuthorization(),a.base.checkCollect()]},watchFilters:function(){return[a.base.checkAuthorization(),a.base.checkCollect()]},collectFilters:function(b,c){return[a.base.checkAuthorization(),a.base.createResource(b),a.base.checkContentType(c),a.base.checkVersion(),a.base.checkCollect()]},createAndCollectFilters:function(b,c){return[a.base.checkAuthorization(),a.base.createResource(b),a.base.checkCollect(),a.base.checkContentType(c),a.base.checkVersion()]}};return b}(ozpIwc.api.filter);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.locks=ozpIwc.api.locks||{},ozpIwc.api.locks.Api=function(a,b,c,d,e){var f=e.extend(a.base.Api,function(a){if(!a.router)throw Error("API must be configured with a router.");if(!a.authorization)throw Error("API must be configured with an authorization module.");this.name="locks.api",this.coordinationAddress="coord."+this.name,this.events=new e.Event,this.events.mixinOnOff(this),this.router=a.router,this.endpoints=[],this.data={},this.watchers={},this.collectors=[],this.changeList={},this.authorization=a.authorization,this.enableRequestQueue(),this.enableSendQueue(),g(this,a.consensusMember),h(this),this.logPrefix="["+this.name+"/"+this.participant.address+"] ",this.leaderState="loading",this.transitionToLeader();var b=this;e.addEventListener("beforeunload",function(){b.shutdown()})});e.PacketRouter.mixin(f);var g=function(a,b){a.consensusMember=b||new d.consensus.Bully({name:a.name,authorization:a.authorization,router:a.router,gatherLogs:function(){return a.createDeathScream()}}),a.consensusMember.on("receivedLogs",i,a),a.consensusMember.on("changedState",j,a),e.runningInWorker&&a.consensusMember.participant.connect().then(function(){a.consensusMember.onBecomeCoordinator()})},h=function(a){a.participant=new d.participant.Client({internal:!0,authorization:a.authorization,router:a.router,name:a.name}),a.participant.on("receive",function(b){a.receivePacketContext(b)}),a.participant.on("addressDisconnects",a.unlockAll,a),a.router.registerMulticast(a.participant,[a.name]),"coordinator"===a.consensusMember.state&&a.deliverRequestQueue()},i=function(a){if(!this.initialized){this.initialized=!0;var b=a.timestamp;this.initializeData(a),this.deliverRequestQueue(b)}},j=function(a){switch(b.debug("["+this.participant.address+"] State: ",a),a){case"coordinator":this.deliverRequestQueue(),this.deliverSendQueue();break;default:this.participant.sendingBlocked=!0,this.flushSendQueue()}};return f.prototype.transitionToLeader=function(){return"loading"!==this.leaderState?void b.error(this.logPrefix+"transition to leader called in an invalid state:",this.leaderState):(b.debug(this.logPrefix+"transitioning to leader"),this.leaderState="leader",void this.broadcastLeaderReady())},f.prototype.unlockAll=function(a){var b=this;e.object.eachEntry(this.data,function(c,d){b.updateLock(d,d.unlock({src:a}))})},f.prototype.cleanup=function(){var a={};e.object.eachEntry(this.data,function(b,c){var d=c.entity.queue||[];d.forEach(function(b){a[b.src]=!0})});var b=this;this.participant.names().bulkGet("/address").then(function(b){b.entity.forEach(function(b){b.entity.time&&b.entity.time+c.heartBeatFrequency>e.now()&&(a[b.entity.address]=!1)})}).then(function(){e.object.eachEntry(a,function(a,c){c&&b.unlockAll(a)})})},f.prototype.createNodeObject=function(b){return new a.locks.Node(b)},f.prototype.shutdown=function(){this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"unlock"})},f.useDefaultRoute=function(b,c){c=c||"{resource:.*}",b=e.ensureArray(b);var d=this;b.forEach(function(b){var e=a.filter.standard.forAction(b);d.declareRoute({action:b,resource:c,filters:e?e():[]},a.base.Api.defaultHandler[b])})},f.useDefaultRoute(["bulkGet","list","get","watch","unwatch"]),f.declareRoute({action:["bulkSend"],resource:"{resource:.*}",filters:[]},function(a,b,c){var e=a.entity||[],f=this;return e.forEach(function(a){var b=new d.PacketContext({packet:a.packet,router:f.router,srcParticipant:a.packet.src,dstParticipant:f.address});f.receiveRequestPacket(b)}),{response:"ok"}}),f.declareRoute({action:"lock",resource:"/mutex/{name}",filters:a.filter.standard.setFilters(a.locks.Node)},function(a,b,c){b.node&&this.updateLock(b.node,b.node.lock({src:a.src,msgId:a.msgId}))}),f.declareRoute({action:"unlock",resource:"/mutex/{name}",filters:a.filter.standard.setFilters(a.locks.Node)},function(a,c,d){a.entity=a.entity||{},b.debug("[locks.api"+c.node.resource+"][UNLOCK]: ",a.src),c.node&&this.updateLock(c.node,c.node.unlock({src:a.entity.src||a.src,msgId:a.entity.msgId||a.msgId,entity:a.entity.state||c.node.entity.state}))}),f.prototype.updateLock=function(a,c){if(c){b.debug("[locks.api"+a.resource+"][NEW LEADER]",c);var d={dst:c.src,src:this.participant.name,replyTo:c.msgId,response:"ok",resource:a.resource,entity:a.entity.state};this.isSendQueueing?this.sendQueue.push(d):this.participant.send(d)}},f}(ozpIwc.api,ozpIwc.log,ozpIwc.config,ozpIwc.transport,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.locks=ozpIwc.api.locks||{},ozpIwc.api.locks.Node=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments),this.entity={owner:null,queue:[]}});return c.prototype.lock=function(a){this.entity.queue=this.entity.queue||[];for(var c in this.entity.queue){var d=this.entity.queue[c];if(d.src===a.src&&d.msgId===a.msgId)return null}return this.entity.queue.push(a),this.entity.owner=this.entity.owner||{},b.objectContainsAll(this.entity.owner,this.entity.queue[0])?null:(this.entity.owner=this.entity.queue[0],a.eTag?this.version=a.eTag:this.version++,this.entity.owner)},c.prototype.unlock=function(a){return this.entity.queue=this.entity.queue.filter(function(c){return!b.objectContainsAll(c,a)}),this.entity.state=a.entity||this.entity.state,b.objectContainsAll(this.entity.owner,this.entity.queue[0])?(0===this.entity.queue.length&&(a.eTag?this.version=a.eTag:this.version++,this.entity.owner=null),null):(this.entity.owner=this.entity.queue[0],a.eTag?this.version=a.eTag:this.version++,this.entity.owner)},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.data=ozpIwc.api.data||{},ozpIwc.api.data.Api=function(a,b,c){var d=a.createApi("data.api",function(d){this.endpoints=d.endpoints||[{link:b.linkRelPrefix+":user-data",headers:[]}],this.contentTypeMappings=c.genContentTypeMappings(a.data.node)});return d.prototype.findNodeType=function(b){var d=c.getFormattedContentType(b);if(!d.name){var e=a.uriTemplate("ozp:data-item")||{};d=c.getFormattedContentType(e.type)}var f=this.contentTypeMappings[d.name];return f?d.version?f[d.version]:f:a.data.node.NodeV2},d.prototype.createNodeObject=function(a,b){return b?new b(a):void 0},d}(ozpIwc.api,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.data=ozpIwc.api.data||{},ozpIwc.api.data.node=ozpIwc.api.data.node||{},ozpIwc.api.data.node.Node=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments),b.lifespan||(this.lifespan=new a.Lifespan.Persistent),this.contentType=c.serializedContentType});return c.prototype.uriTemplate="ozp:data-item",c.prototype.serialize=function(){return JSON.stringify({key:this.resource,entity:this.entity,collection:this.collection,pattern:this.pattern,contentType:this.contentType,permissions:this.permissions,version:this.version,self:this.self})},c.serializedContentType="application/vnd.ozp-iwc-data-object-v1+json",c.prototype.deserializedEntity=function(a,b){if("string"!=typeof a.entity)return a.entity;try{return JSON.parse(a.entity)}catch(c){return a.entity}},c.prototype.deserialize=function(b,c){try{b=JSON.parse(b)}catch(d){}a.base.Node.prototype.deserialize.apply(this,[b.entity,c]),"string"==typeof this.permissions&&(this.permissions=JSON.parse(this.permissions)),"string"==typeof this.version&&(this.version=JSON.parse(this.version))},c.prototype.resourceFallback=function(a){return a.key?("/"===a.key.charAt(0)?"":"/")+a.key:void 0},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.data=ozpIwc.api.data||{},ozpIwc.api.data.node=ozpIwc.api.data.node||{},ozpIwc.api.data.node.NodeV2=function(a,b){var c=b.extend(a.data.node.Node,function(b){a.data.node.Node.apply(this,arguments),this.contentType=c.serializedContentType});return c.prototype.serialize=function(){return{key:this.resource,entity:JSON.stringify(this.entity),content_type:this.contentType,version:this.version,pattern:this.pattern,collection:b.ensureArray(this.collection),permissions:b.ensureObject(this.permissions)}},c.serializedContentType="application/vnd.ozp-iwc-data-object+json;version=2",c.prototype.deserialize=function(b,c){a.base.Node.prototype.deserialize.apply(this,arguments),"string"==typeof this.permissions&&(this.permissions=JSON.parse(this.permissions)),"string"==typeof this.version&&(this.version=JSON.parse(this.version))},c.prototype.deserializedEntity=function(a){return a=a||{},JSON.parse(a.entity)},c.prototype.resourceFallback=function(){if(this.self.href){for(var b=a.endpoint("ozp:user-data").baseUrl;"/"===b.slice(-1);)b=b.slice(0,-1);if(0===this.self.href.indexOf(b))return this.self.href.replace(b,"")}},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.data=ozpIwc.api.data||{},ozpIwc.api.data.Api=function(a,b){b.useDefaultRoute(a.base.Api.allActions);var c=function(){var b={},c=a.filter.standard.createAndCollectFilters(a.data.node.Node);return c.unshift(function(a,c,d,e){return b.pattern=a.pattern,b.lifespan=a.lifespan,a.pattern=void 0,a.lifespan=void 0,e()}),c.push(function(a,c,d,e){return a.pattern=b.pattern,a.lifespan=b.lifespan,e()}),c};return b.declareRoute({action:["addChild"],resource:"{resource:.*}",filters:c()},function(b,c,d){var e=this.createKey(c.node.pattern);b.resource=e,b.pattern=b.pattern||e+"/";var f=this.createNode({resource:e,lifespan:b.lifespan,src:b.src},a.data.node.Node);return this.addCollector(c.node),this.markForChange(f),f.set(b),{response:"ok",entity:{resource:f.resource}}}),b.declareRoute({action:["removeChild"],resource:"{resource:.*}",filters:a.filter.standard.deleteFilters()},function(a,b,c){return a.entity&&a.entity.resource&&(a.resource=a.entity.resource,b.node=this.data[a.resource],b.node&&(this.markForChange(b.node),b.node.markAsDeleted(a))),{response:"ok"}}),b}(ozpIwc.api,ozpIwc.api.data.Api||{});var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.Api=function(a,b,c,d){var e=a.createApi("intents.api",function(b){this.endpoints=b.endpoints||[{link:c.linkRelPrefix+":intent",headers:[]}],this.contentTypeMappings=d.genContentTypeMappings(a.intents.node)});e.prototype.initializeData=function(c){if(c=c||{watchers:{},collectors:[],data:[]},this.watchers=c.watchers,this.collectors=c.collectors,c.data.forEach(function(b){0===b.resource.indexOf("/inFlightIntent")?(b.entity=b.entity||{},b.entity.dState=b.entity.state,b.entity.state="deserialize",this.createNode({resource:b.resource,invokePacket:{},handlerChoices:[0,1],state:"deserialize"},a.intents.InFlightNode).deserializeLive(b)):this.createNode({resource:b.resource}).deserializeLive(b)},this),this.updateCollections(),this.endpoints){var e=this,f=function(a){e.loadedResourceHandler(a)};return Promise.all(this.endpoints.map(function(a){return d.halLoader.load(a.link,a.headers,f)["catch"](function(a){b.error(e.logPrefix,"load from endpoint failed. Reason: ",a)})}))}return Promise.resolve()},e.prototype.findNodeType=function(a){var b=d.getFormattedContentType(a),c=this.contentTypeMappings[b.name];return c?b.version?c[b.version]:c:void 0};var f=function(a,b){var c=b.entity.reply||{};return a.send({dst:b.entity.invokePacket.src,replyTo:b.entity.invokePacket.msgId,response:"update",entity:{request:b.entity.entity,response:c.entity,handler:b.entity.handler,state:b.entity.state,status:b.entity.status}})};return e.prototype.invokeIntentHandler=function(b,c,d,e,g){var h=new a.intents.node.InFlightNode({resource:this.createKey("/inFlightIntent/"),src:b.src,invokePacket:b,type:c,action:d,handlerChoices:e,pattern:g});return this.data[h.resource]=h,this.addCollector(h),f(this,h),this.data[h.resource]=a.intents.FSM.transition(h),this.handleInflightIntentState(h)},e.prototype.handleInflightIntentState=function(a){switch(a.entity.state){case"choosing":return this.handleChoosing(a);case"delivering":this.handleDelivering(a);break;case"complete":this.handleComplete(a);break;case"error":this.handleError(a);break;default:f(this,a)}return Promise.resolve(a)},e.prototype.handleChoosing=function(e){var g=this,h=function(b){var f=function(f){var h=d.clone(f.entity.invokeIntent);return h.entity=h.entity||{},h.src=h.src||h.dst,h.replyTo=f.entity.replyTo,h.entity.inFlightIntent=b.toPacket(),h.entity.force=11===d.getInternetExplorerVersion(),d.runningInWorker&&(h.entity.config=c,h.entity.config.intentSelection="intents.api"+e.resource),g.invokeIntentHandler(h,"/inFlightIntent/chooser","choose",[f],"/inFlightIntent/chooser/choose/").then(function(b){if(b.entity=b.entity||{},"complete"===b.entity.state)return!0;if("error"===b.entity.state)throw"err";var c,d,e=new Promise(function(a,b){c=a,d=b}),f=function(d){d.resource===b.resource&&(a.intents.FSM.off("complete",f),c(!0))},g=function(c){c.resource===b.resource&&(a.intents.FSM.off("error",g),d("err"))};return a.intents.FSM.on("complete",f),a.intents.FSM.on("error",g),e})},h=function(a){return a.length>0?f(a[0]).then(function(){return Promise.resolve()})["catch"](function(b){return a.shift(),h(a)}):Promise.reject("no choosers.")},i=g.matchingNodes("/inFlightIntent/chooser/choose/"+b.entity.invokePacket.src),j=g.matchingNodes("/inFlightIntent/chooser/choose/");return h(i)["catch"](function(a){return h(j)})},i=function(f){return b.info("Picking chooser because",f),h(e)["catch"](function(f){return 11!==d.getInternetExplorerVersion()?(b.info("launching popup chooser because: ",f),d.runningInWorker||d.openWindow(c.intentsChooserUri,{"ozpIwc.peer":c._busRoot,"ozpIwc.intentSelection":"intents.api"+e.resource},c.intentChooserFeatures)):(b.error("Failed to handle intent choosing: Internet Explorer 11 is not supported for the default intent chooser."),e=a.intents.FSM.transition(e,{state:"error"})),e})};return f(this,e),this.getPreference(e.entity.invokePacket.src+"/"+e.entity.intent.type+"/"+e.entity.intent.action).then(function(b){return b in g.data?(e=a.intents.FSM.transition(e,{entity:{state:"delivering",handler:{resource:b,reason:"remembered"}}}),f(g,e),g.handleInflightIntentState(e)):i()})["catch"](i)},e.prototype.handleDelivering=function(a){var c=this.data[a.entity.handler.resource],e=d.clone(c.entity.invokeIntent);return e.entity=e.entity||{},e.replyTo=c.entity.replyTo,e.entity.inFlightIntent=a.toPacket(),b.debug(this.logPrefix+"delivering intent:",e),f(this,a),this.send(e)},e.prototype.handleComplete=function(a){a.entity.invokePacket&&a.entity.invokePacket.src&&a.entity.reply&&(this.send({dst:a.entity.invokePacket.src,replyTo:a.entity.invokePacket.msgId,contentType:a.entity.reply.contentType,response:"complete",resource:a.entity.handler.resource,entity:a.entity.reply.entity}),f(this,a)),a.markAsDeleted()},e.prototype.handleError=function(a){a.entity.invokePacket&&a.entity.invokePacket.src&&(this.send({dst:a.entity.invokePacket.src,replyTo:a.entity.invokePacket.msgId,contentType:a.entity.reply.contentType,response:"noResult",resource:a.entity.handler.resource,entity:a.entity.reply.entity}),f(this,a)),a.markAsDeleted()},e}(ozpIwc.api,ozpIwc.log,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.FSM=function(a,b){var c={};return c.events=new b.Event,c.events.mixinOnOff(c),c.states={},c.states.init=function(){var a=this.entity.handlerChoices,b={};if(!a||a===[])return b.state="error",b.error="noChoices",c.transition(this,{entity:b});if(Array.isArray(a)){var d=1===a.length&&a[0]&&a[0].entity&&a[0].entity.invokeIntent&&"launch"===a[0].entity.invokeIntent.action;1!==a.length||d?b.state="choosing":(b.handler={resource:a[0].resource,reason:"onlyOne"},b.state="delivering")}else"object"==typeof a?(b.handler={resource:a.resource,reason:"onlyOne"},b.state="delivering"):(b.state="error",b.error="unknown choices.");return c.transition(this,{entity:b})},c.states.error=function(a){var b=a.reply||{};return b.entity=b.entity||"Unknown Error.",b.contentType=b.contentType||"text/plain",this.entity=this.entity||{},this.entity.reply=b,this.entity.state="error",this.version++,c.stateEvent(this)},c.states.delivering=function(b){if(!b.handler||!b.handler.resource||!b.handler.reason)throw new a.error.BadStateError("Choosing state requires a resource and reason");return this.entity.handler=b.handler,this.entity.state="delivering",this.version++,c.stateEvent(this)},c.states.running=function(b){if(!b.handler||!b.handler.address)throw new a.error.BadContentError("Entity lacks a 'handler.address' field");return this.entity.handler.address=b.handler.address,this.entity.state="running",this.version++,c.stateEvent(this)},c.states.choosing=function(){return this.entity.state="choosing",this.version++,c.stateEvent(this)},c.states.complete=function(a){return this.entity.reply=a.reply,this.entity.state="complete",this.version++,c.stateEvent(this)},c.stateTransitions={init:{init:c.states.init,error:c.states.error,delivering:c.states.delivering,choosing:c.states.choosing},choosing:{error:c.states.error,delivering:c.states.delivering,complete:c.states.complete},delivering:{error:c.states.error,running:c.states.running,complete:c.states.complete},running:{error:c.states.error,complete:c.states.complete},complete:{},error:{}},c.transition=function(b,d){if(d=d||{entity:{state:"init"}},!d.entity||!d.entity.state)throw new a.error.BadContentError("Entity lacks a 'state' field");if(b.deleted)throw new a.error.BadContentError("Already handled.");var e=c.stateTransitions[b.entity.state];if(!e)return c.states.error.call(b,{entity:{error:"Inflight intent is in an invalid state.  Cannot proceed."}});if(e=e[d.entity.state],!e)throw new a.error.BadStateError("In-flight intent cannot transition from "+b.entity.state+" to "+d.entity.state);return e.call(b,d.entity)},c.stateEvent=function(a){return a.entity&&a.entity.state&&c.events.trigger(a.entity.state,a),a},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.node=ozpIwc.api.intents.node||{},ozpIwc.api.intents.node.DefinitionNode=function(a,b,c){var d=c.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments),this.contentType=d.serializedContentType,this.lifespan=new a.Lifespan.Ephemeral,this.entity=b.entity||{}});return d.serializedContentType="application/vnd.ozp-iwc-intent-definition-v1+json",d}(ozpIwc.api,ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.node=ozpIwc.api.intents.node||{},ozpIwc.api.intents.node.HandlerNode=function(a,b,c){var d=c.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments),this.contentType=d.serializedContentType,this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),this.entity=b.entity||{}});return d.serializedContentType="application/vnd.ozp-iwc-intent-handler-v1+json",d.prototype.set=function(c){var d=c.src;if(c.entity&&c.entity.invokeIntent&&c.entity.invokeIntent.dst&&(d=c.entity.invokeIntent.dst),!(d||this.entity&&this.entity.invokeIntent))throw b.error("Handler lacks a invokeIntent.dst",c),new a.error.BadContentError("Intent handler must supply invokeIntent.dst");a.base.Node.prototype.set.apply(this,arguments),
this.entity.invokeIntent=this.entity.invokeIntent||{},this.entity.invokeIntent.dst=d,this.entity.replyTo=c.msgId},d}(ozpIwc.api,ozpIwc.log,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.node=ozpIwc.api.intents.node||{},ozpIwc.api.intents.node.InFlightNode=function(a,b){var c=b.extend(a.base.Node,function(b){if(b=b||{},a.base.Node.apply(this,arguments),this.contentType=c.serializedContentType,this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),!b.invokePacket)throw new a.error.BadContentError("In flight intent requires an invocation packet");if(!b.handlerChoices||Array.isArray(b.handlerChoices)&&0===b.handlerChoices.length)throw new a.error.NoResourceError("No handlers available");this.entity={intent:{type:b.type,action:b.action},invokePacket:b.invokePacket,contentType:b.invokePacket.contentType,entity:b.invokePacket.entity||{},state:"init",status:"ok",handlerChoices:b.handlerChoices,handler:{resource:null,address:null},reply:null}});return c.serializedContentType="application/vnd.ozp-inflight-intent-v1+json",c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.intents=ozpIwc.api.intents||{},ozpIwc.api.intents.Api=function(a,b,c){b.useDefaultRoute(["bulkGet","list"]),b.useDefaultRoute(["watch","unwatch","delete"],"/inFlightIntent/{id}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/{major}/{minor}/{action}/{handlerId}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/{major}/{minor}/{action}"),b.useDefaultRoute(["watch","unwatch","get"],"/"),b.useDefaultRoute(["watch","unwatch","get"],"/{major}"),b.useDefaultRoute(["watch","unwatch","get"],"/{major}/{minor}");var d=function(){var b=function(a,b,c,d){return this.addCollector(b.node),d()},c=a.filter.standard.setFilters(a.intents.node.DefinitionNode);return c.unshift(a.filter.base.fixPattern()),c.push(b),c},e=function(){var a=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action,b.node=this.data[a.resource],d()},b=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action+"/"+c.handlerId,a.pattern="",b.node=this.data[a.resource],d()},c=d();return c.unshift(a),c.push(b),c};return b.declareRoute({action:"set",resource:"/inFlightIntent/{id}",filters:a.filter.standard.setFilters(a.intents.node.InFlightNode)},function(b,c,d){return c.node=a.intents.FSM.transition(c.node,b),this.handleInflightIntentState(c.node).then(function(){return{response:"ok"}})}),b.declareRoute({action:["set","delete"],resource:"/{major}/{minor}",filters:[]},function(b,c,d){throw new a.error.NoPermissionError(b)}),b.declareRoute({action:"get",resource:"/{major}/{minor}",filters:[]},function(a,b,c){return b.node?b.node.toPacket():{response:"ok",entity:{type:c.major+"/"+c.minor,actions:this.matchingNodes(a.resource).map(function(a){return a.entity.action})}}}),b.declareRoute({action:"register",resource:"/{major}/{minor}/{action}",filters:d()},function(b,d,e){var f=this.createNode({resource:this.createKey(d.node.resource+"/"),src:b.src},a.intents.node.HandlerNode);return f.set(b),c.debug(this.logPrefix+" registered ",d.node),{response:"ok",entity:{resource:f.resource}}}),b.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}",filters:a.filter.standard.getFilters()},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.pattern),b.node.pattern)}),b.declareRoute({action:"broadcast",resource:"/{major}/{minor}/{action}",filters:a.filter.standard.getFilters()},function(a,b,c){for(var d in b.node.collection)this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.collection[d]),b.node.collection[d]);return{response:"pending",entity:{handlers:b.node.collection}}}),b.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}/{handlerId}",filters:[]},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,b.node,void 0)}),b.declareRoute({action:"set",resource:"/{major}/{minor}/{action}/{handlerId}",filters:a.filter.standard.setFilters(a.intents.HandlerNode)},function(a,b,c){return b.node.set(a),{response:"ok"}}),b.declareRoute({action:"register",resource:"/{major}/{minor}/{action}/{handlerId}",filters:e()},function(b,d,e){var f=this.createNode({resource:b.resource,src:b.src},a.intents.node.HandlerNode);return f.set(b),c.debug(this.logPrefix+" registered ",d.node),{response:"ok",entity:{resource:f.resource}}}),b}(ozpIwc.api,ozpIwc.api.intents.Api||{},ozpIwc.log);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.names=ozpIwc.api.names||{},ozpIwc.api.names.Api=function(a,b,c,d,e){var f=a.createApi("names.api",function(c){this.contentTypeMappings=e.genContentTypeMappings(a.names.node);for(var d in b){var f=b[d],g="/api/"+f.address;this.data[g]=new a.base.Node({resource:g,entity:{actions:f.actions},contentType:"application/vnd.ozp-iwc-api-v1+json"})}});return f.prototype.onStart=function(){var a=this;setInterval(function(){a.checkForNonresponsives()},d.heartBeatFrequency)},f.prototype.onClientDisconnect=function(b){a.base.Api.prototype.onClientDisconnect.apply(this,arguments);var c=b.length,d=this;e.object.eachEntry(this.data,function(a,e){a.substr(-c)===b&&(d.markForChange(e),e.markAsDeleted())})},f.prototype.createNodeObject=function(b,c){return c?new c(b):new a.base.Node(b)},f.prototype.checkForNonresponsives=function(){var a=this;this.matchingNodes("/address").forEach(function(b){var f=e.now()-b.entity.time;f>3*d.heartBeatFrequency&&(c.log("["+b.resource+"] [Removing] Time since update:",e.now()-b.entity.time),a.participant.send({dst:"$bus.multicast",action:"disconnect",entity:b.entity}),b.markAsDeleted())})},f}(ozpIwc.api,ozpIwc.apiMap,ozpIwc.log,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.names=ozpIwc.api.names||{},ozpIwc.api.names.Node=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments),this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),this.entity=b.entity||{}});return c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.names=ozpIwc.api.names||{},ozpIwc.api.names.Api=function(a,b){return b.useDefaultRoute(["list","bulkGet"],"{c:/}"),b.useDefaultRoute(["list","bulkGet"],"{c:/(?:api|address|multicast|router).*}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/api/{addr}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/address/{addr}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}/{memberAddr}"),b.useDefaultRoute(["get","delete","watch","unwatch"],"/router/{addr}"),b.declareRoute({action:["set","delete"],resource:"/{collection:api|address|multicast|router}",filters:[]},function(b,c,d){throw new a.error.NoPermissionError(b)}),b.declareRoute({action:"get",resource:"/{collection:api|address|multicast|router}",filters:[]},function(a,b,c){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),b.declareRoute({action:"set",resource:"/api/{addr}",filters:a.filter.standard.setFilters(a.base.Node,"application/vnd.ozp-iwc-api-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),b.declareRoute({action:"set",resource:"/address/{addr}",filters:a.filter.standard.setFilters(a.names.Node,"application/vnd.ozp-iwc-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),b.declareRoute({action:"set",resource:"/multicast/{addr}",filters:a.filter.standard.setFilters(a.base.Node,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),b.declareRoute({action:"set",resource:"/multicast/{group}/{member}",filters:a.filter.standard.setFilters(a.names.Node,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),b.declareRoute({action:"set",resource:"/router/{addr}",filters:a.filter.standard.setFilters(a.names.Node,"application/vnd.ozp-iwc-router-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),b}(ozpIwc.api,ozpIwc.api.names.Api||{});var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.Api=function(a,b,c,d){var e=a.createApi("system.api",function(b){this.endpoints=b.endpoints||[{link:c.linkRelPrefix+":user",headers:[]},{link:c.linkRelPrefix+":system",headers:[]},{link:c.linkRelPrefix+":application",headers:[]}],this.contentTypeMappings=d.genContentTypeMappings(a.system.node),this.on("createdNode",this.updateIntents,this)});return e.prototype.onStart=function(){if(!d.runningInWorker){b.debug("System.api registering for the launch intent");var a={lifespan:"ephemeral",entity:{type:"application/vnd.ozp-iwc-launch-data-v1+json",action:"run",label:"Open in new tab",invokeIntent:{dst:"system.api",action:"invoke",resource:"/launchNewWindow"}}};return this.participant.intents().register("/application/vnd.ozp-iwc-launch-data-v1+json/run/system.api",a)["catch"](function(a){b.error("System.api failed to register for launch intent: ",a)})}},e.prototype.findNodeType=function(a){var b=d.getFormattedContentType(a),c=this.contentTypeMappings[b.name];return c?b.version?c[b.version]:c:void 0},e.prototype.createNodeObject=function(a,b){return b?new b(a):void 0},e.prototype.updateIntents=function(a){if(a.entity&&a.entity.intents){var b=[];return a.entity.intents.forEach(function(c){var d=c.icon||a.entity&&a.entity.icons&&a.entity.icons.small?a.entity.icons.small:"",e=c.label||a.entity.name,f="/"+c.type+"/"+c.action+"/system.api"+a.resource.replace(/\//g,"."),g={lifespan:"ephemeral",entity:{type:c.type,action:c.action,icon:d,label:e,_links:a.entity._links,invokeIntent:{action:"launch",dst:"system.api",resource:a.resource}}};b.push(this.participant.intents().messageBuilder.register(f,g))},this),this.participant.intents().bulkSend(b).then(function(a){return Promise.all(b)})}},e}(ozpIwc.api,ozpIwc.log,ozpIwc.config,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.ApplicationNode=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-application-v1+json",c.prototype.deserializedEntity=function(a){var b=["_embedded","_links"],c={};for(var d in a)a.hasOwnProperty(d)&&-1===b.indexOf(d)&&(c[d]=a[d]);return c},c.prototype.resourceFallback=function(a){return a.unique_name?"/application/"+a.unique_name:a.id?"/application/"+a.id:void 0},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.ApplicationNodeV2=function(a,b){var c=b.extend(a.system.node.ApplicationNode,function(b){a.system.node.ApplicationNode.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-iwc-application+json;version=2",c.prototype.deserializedEntity=function(a){return a=a||{},a.small_icon=a.small_icon||{},{id:a.id,name:a.title,launchUrls:{"default":a.launch_url},icons:{small:a.small_icon.url},intents:b.ensureArray(a.intents)}},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.SystemNode=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-iwc-system-v1+json",c.prototype.deserializedEntity=function(a){return a=a||{},{name:a.name,version:a.version}},c.prototype.resourceFallback=function(){return"/system"},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.SystemNodeV2=function(a,b){var c=b.extend(a.system.node.SystemNode,function(b){a.system.node.SystemNode.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-iwc-system+json;version=2",c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.UserNode=function(a,b){var c=b.extend(a.base.Node,function(b){a.base.Node.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-profile-v1+json",c.prototype.deserializedEntity=function(a){return a=a||{},{displayName:a.displayName,id:a.id,username:a.username}},c.prototype.resourceFallback=function(){return"/user"},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.node=ozpIwc.api.system.node||{},ozpIwc.api.system.node.UserNodeV2=function(a,b){var c=b.extend(a.system.node.UserNode,function(b){a.system.node.UserNode.apply(this,arguments)});return c.serializedContentType="application/vnd.ozp-iwc-user+json;version=2",c.prototype.deserializedEntity=function(a){return a=a||{},{displayName:a.display_name,id:a.id,username:a.username}},c}(ozpIwc.api,ozpIwc.util);var ozpIwc=ozpIwc||{};ozpIwc.api=ozpIwc.api||{},ozpIwc.api.system=ozpIwc.api.system||{},ozpIwc.api.system.Api=function(a,b,c,d,e){return b.useDefaultRoute(["bulkGet","list"]),b.useDefaultRoute(["get","watch","unwatch"],"/user"),b.useDefaultRoute(["get","watch","unwatch"],"/system"),b.useDefaultRoute(["get","watch","unwatch"],"/application/{id}"),b.declareRoute({action:"get",resource:"/{collection:application}",filters:[]},function(a,b,c){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),b.declareRoute({action:["set","delete"],resource:"/user",filters:[]},function(b,c,d){throw new a.error.BadActionError(b)}),b.declareRoute({action:["set","delete"],resource:"/system",filters:[]},function(b,c,d){throw new a.error.BadActionError(b)}),b.declareRoute({action:["set","delete"],resource:"/application/{id}",filters:[]},function(b,c,d){throw new a.error.BadActionError(b)}),b.declareRoute({action:["launch"],resource:"/application/{id}",filters:a.filter.standard.getFilters()},function(a,b,d){c.debug(this.logPrefix+" launching ",a.entity);var f={url:b.node.entity.launchUrls["default"],applicationId:b.node.resource,launchData:a.entity,id:b.node.entity.id},g="/application/vnd.ozp-iwc-launch-data-v1+json/run";return e.runningInWorker&&(g+="/",g+=a.entity&&a.entity.inFlightIntent&&a.entity.inFlightIntent.entity&&a.entity.inFlightIntent.entity.invokePacket&&a.entity.inFlightIntent.entity.invokePacket.src?a.entity.inFlightIntent.entity.invokePacket.src:a.src),this.participant.send({dst:"intents.api",action:"invoke",resource:g,entity:f}),{response:"ok"}}),b.declareRoute({action:["invoke"],resource:"/launchNewWindow",filters:[]},function(a,b,f){return c.debug(this.logPrefix+" handling launch data ",a.entity),a.entity&&a.entity.inFlightIntent?(e.openWindow(a.entity.inFlightIntent.entity.entity.url,{"ozpIwc.peer":d._busRoot,"ozpIwc.inFlightIntent":a.entity.inFlightIntent.resource}),{response:"ok"}):{response:"badResource"}}),b}(ozpIwc.api,ozpIwc.api.system.Api||{},ozpIwc.log,ozpIwc.config,ozpIwc.util),ozpIwc.config.backendSupport||(ozpIwc.endpointConfig={dataApi:[],systemApi:[],intentsApi:[]}),ozpIwc.config.legacySupport&&(ozpIwc.util.structuredCloneSupport=function(){return!1});var ozpIwc=ozpIwc||{};ozpIwc.wiring=function(a,b,c){var d=ozpIwc.util.parseQueryParams();if(c.setThreshold(ozpIwc.config.logLevel),d.log)try{console.log("Setting log level to ",d.log),c.setThreshold(ozpIwc.log[d.log.toUpperCase()])}catch(e){}return b.metrics=new ozpIwc.metric.Registry,b.authorization=new ozpIwc.policyAuth.points.PDP({pip:new ozpIwc.policyAuth.points.PIP,prp:new ozpIwc.policyAuth.points.PRP,setsEndpoint:a.policyRootUrl}),b.ajaxQueue=new ozpIwc.util.AjaxPersistenceQueue({poolSize:a.ajaxPoolSize}),b}(ozpIwc.config,ozpIwc.wiring||{},ozpIwc.log);var ozpIwc=ozpIwc||{};ozpIwc.wiring=ozpIwc.wiring||{},ozpIwc.wiring=function(a,b,c,d,e,f){if(!e._testMode){var g=function(){},h=function(){g()};a.endpointInitPromise=b.initEndpoints({apiRoot:e.apiRootUrl,ajaxQueue:a.ajaxQueue,templates:e.templates}),a.peer=new d.Peer({metrics:a.metrics}),f.runningInWorker||(a.link=new d.KeyBroadcastLocalStorageLink({metrics:a.metrics,peer:a.peer})),a.router=new c.Router({authorization:a.authorization,metrics:a.metrics,peer:a.peer,heartbeatFrequency:e.heartBeatFrequency}),e.allowLocalClients&&(a.listeners=a.listeners||{},f.runningInWorker?a.listeners.sharedWorker=new c.listener.SharedWorker({authorization:a.authorization,router:a.router,ready:new Promise(function(a){g=a})}):a.listeners.postMessage=new c.listener.PostMessage({authorization:a.authorization,router:a.router,ready:new Promise(function(a){g=a})})),e.runApis&&(h=function(){ozpIwc.endpointConfig=ozpIwc.endpointConfig||{},a.apis=a.apis||{},a.apis.locks=new b.locks.Api({authorization:a.authorization,router:a.router}),a.apis.names=new b.names.Api({authorization:a.authorization,router:a.router}),a.apis.data=new b.data.Api({authorization:a.authorization,endpoints:ozpIwc.endpointConfig.dataApi,router:a.router,ajaxQueue:a.ajaxQueue}),a.apis.intents=new b.intents.Api({authorization:a.authorization,endpoints:ozpIwc.endpointConfig.intentsApi,router:a.router,ajaxQueue:a.ajaxQueue}),a.apis.system=new b.system.Api({authorization:a.authorization,endpoints:ozpIwc.endpointConfig.systemApi,router:a.router,ajaxQueue:a.ajaxQueue}),g()}),ozpIwc.util.prerender().then(h)}return a}(ozpIwc.wiring,ozpIwc.api,ozpIwc.transport,ozpIwc.network,ozpIwc.config,ozpIwc.util);
//# sourceMappingURL=ozpIwc-bus.min.js.map